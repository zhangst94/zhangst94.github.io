<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>二进制安装Kubernetesv1.24.2IPv4、IPv6双栈 | 运维技术笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/imgs/favicon.ico">
    <meta name="description" content="运维技术博客，积跬步以至千里，致敬每个爱学习的你">
    <meta name="keywords" content="个人技术博客,技术文档">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.29d22670.css" as="style"><link rel="preload" href="/assets/js/app.29507997.js" as="script"><link rel="preload" href="/assets/js/2.e4478836.js" as="script"><link rel="preload" href="/assets/js/49.86a92706.js" as="script"><link rel="prefetch" href="/assets/js/10.52ab9d51.js"><link rel="prefetch" href="/assets/js/100.1dfc8ac4.js"><link rel="prefetch" href="/assets/js/101.eb1804b5.js"><link rel="prefetch" href="/assets/js/102.f854c9f8.js"><link rel="prefetch" href="/assets/js/103.d1bad4dc.js"><link rel="prefetch" href="/assets/js/104.96d01c3a.js"><link rel="prefetch" href="/assets/js/105.a536f3c3.js"><link rel="prefetch" href="/assets/js/106.f5970192.js"><link rel="prefetch" href="/assets/js/107.d139e728.js"><link rel="prefetch" href="/assets/js/108.bf47ca38.js"><link rel="prefetch" href="/assets/js/109.5d7e1db3.js"><link rel="prefetch" href="/assets/js/11.e6decff9.js"><link rel="prefetch" href="/assets/js/110.ee238630.js"><link rel="prefetch" href="/assets/js/111.0bb5543e.js"><link rel="prefetch" href="/assets/js/112.2dceab0e.js"><link rel="prefetch" href="/assets/js/113.a0c9ee05.js"><link rel="prefetch" href="/assets/js/114.d7ac497d.js"><link rel="prefetch" href="/assets/js/115.22bc0e52.js"><link rel="prefetch" href="/assets/js/116.ad5f11ce.js"><link rel="prefetch" href="/assets/js/117.90e8f13c.js"><link rel="prefetch" href="/assets/js/118.98e78063.js"><link rel="prefetch" href="/assets/js/119.c5d31497.js"><link rel="prefetch" href="/assets/js/12.f2371008.js"><link rel="prefetch" href="/assets/js/120.38e50cf1.js"><link rel="prefetch" href="/assets/js/121.65d367b0.js"><link rel="prefetch" href="/assets/js/122.e14f6cad.js"><link rel="prefetch" href="/assets/js/123.5bdb4ec7.js"><link rel="prefetch" href="/assets/js/124.f9efa255.js"><link rel="prefetch" href="/assets/js/125.1686d3a4.js"><link rel="prefetch" href="/assets/js/126.a2fc7fc9.js"><link rel="prefetch" href="/assets/js/127.e68425f1.js"><link rel="prefetch" href="/assets/js/128.96597b83.js"><link rel="prefetch" href="/assets/js/129.0cdcef19.js"><link rel="prefetch" href="/assets/js/13.976dcc2d.js"><link rel="prefetch" href="/assets/js/130.5c999995.js"><link rel="prefetch" href="/assets/js/131.07f50df8.js"><link rel="prefetch" href="/assets/js/132.9689c2f3.js"><link rel="prefetch" href="/assets/js/133.a1cee72f.js"><link rel="prefetch" href="/assets/js/134.c5af2a70.js"><link rel="prefetch" href="/assets/js/135.aee6ed93.js"><link rel="prefetch" href="/assets/js/136.8e172c48.js"><link rel="prefetch" href="/assets/js/137.0adfc540.js"><link rel="prefetch" href="/assets/js/138.6084d6d8.js"><link rel="prefetch" href="/assets/js/139.489f71a4.js"><link rel="prefetch" href="/assets/js/14.9625e562.js"><link rel="prefetch" href="/assets/js/140.2f7e3ca4.js"><link rel="prefetch" href="/assets/js/141.a6efd358.js"><link rel="prefetch" href="/assets/js/142.f48b458e.js"><link rel="prefetch" href="/assets/js/143.e964ba84.js"><link rel="prefetch" href="/assets/js/144.a70db263.js"><link rel="prefetch" href="/assets/js/145.554fa780.js"><link rel="prefetch" href="/assets/js/146.ec056ea7.js"><link rel="prefetch" href="/assets/js/147.21763bff.js"><link rel="prefetch" href="/assets/js/148.f106f8c4.js"><link rel="prefetch" href="/assets/js/15.359f374f.js"><link rel="prefetch" href="/assets/js/16.c7287c75.js"><link rel="prefetch" href="/assets/js/17.353c13d6.js"><link rel="prefetch" href="/assets/js/18.f68ff45f.js"><link rel="prefetch" href="/assets/js/19.6def60bc.js"><link rel="prefetch" href="/assets/js/20.33101fec.js"><link rel="prefetch" href="/assets/js/21.cd621a35.js"><link rel="prefetch" href="/assets/js/22.dd3fb27f.js"><link rel="prefetch" href="/assets/js/23.8faf9ba1.js"><link rel="prefetch" href="/assets/js/24.6d38d3b0.js"><link rel="prefetch" href="/assets/js/25.5e0c0ec4.js"><link rel="prefetch" href="/assets/js/26.57fcae39.js"><link rel="prefetch" href="/assets/js/27.1922f4aa.js"><link rel="prefetch" href="/assets/js/28.6fd6b8ff.js"><link rel="prefetch" href="/assets/js/29.3b77fcd7.js"><link rel="prefetch" href="/assets/js/3.602cbeca.js"><link rel="prefetch" href="/assets/js/30.170e6004.js"><link rel="prefetch" href="/assets/js/31.b5c50344.js"><link rel="prefetch" href="/assets/js/32.941a7bbd.js"><link rel="prefetch" href="/assets/js/33.55bc7e64.js"><link rel="prefetch" href="/assets/js/34.a66c1505.js"><link rel="prefetch" href="/assets/js/35.153f5521.js"><link rel="prefetch" href="/assets/js/36.c04269f6.js"><link rel="prefetch" href="/assets/js/37.6e2cdeee.js"><link rel="prefetch" href="/assets/js/38.cb921e43.js"><link rel="prefetch" href="/assets/js/39.2ed36326.js"><link rel="prefetch" href="/assets/js/4.94dce7a4.js"><link rel="prefetch" href="/assets/js/40.209e9286.js"><link rel="prefetch" href="/assets/js/41.afddfad2.js"><link rel="prefetch" href="/assets/js/42.a013330b.js"><link rel="prefetch" href="/assets/js/43.850a36c0.js"><link rel="prefetch" href="/assets/js/44.c084f0c9.js"><link rel="prefetch" href="/assets/js/45.3a22fe9e.js"><link rel="prefetch" href="/assets/js/46.c953397d.js"><link rel="prefetch" href="/assets/js/47.a7665920.js"><link rel="prefetch" href="/assets/js/48.21127c7a.js"><link rel="prefetch" href="/assets/js/5.a039f57b.js"><link rel="prefetch" href="/assets/js/50.aff5e710.js"><link rel="prefetch" href="/assets/js/51.d01884ad.js"><link rel="prefetch" href="/assets/js/52.a9f6dcae.js"><link rel="prefetch" href="/assets/js/53.4a985586.js"><link rel="prefetch" href="/assets/js/54.1fd46a16.js"><link rel="prefetch" href="/assets/js/55.37466240.js"><link rel="prefetch" href="/assets/js/56.00d4c767.js"><link rel="prefetch" href="/assets/js/57.179e219b.js"><link rel="prefetch" href="/assets/js/58.85c01200.js"><link rel="prefetch" href="/assets/js/59.a32f53eb.js"><link rel="prefetch" href="/assets/js/6.124fbfa2.js"><link rel="prefetch" href="/assets/js/60.544c5367.js"><link rel="prefetch" href="/assets/js/61.1745d380.js"><link rel="prefetch" href="/assets/js/62.77f96f64.js"><link rel="prefetch" href="/assets/js/63.3a18c3c3.js"><link rel="prefetch" href="/assets/js/64.5c555100.js"><link rel="prefetch" href="/assets/js/65.ad178295.js"><link rel="prefetch" href="/assets/js/66.ab572eed.js"><link rel="prefetch" href="/assets/js/67.805dd0d4.js"><link rel="prefetch" href="/assets/js/68.b86d7bd3.js"><link rel="prefetch" href="/assets/js/69.f1382968.js"><link rel="prefetch" href="/assets/js/7.be0b0694.js"><link rel="prefetch" href="/assets/js/70.52143576.js"><link rel="prefetch" href="/assets/js/71.162453f3.js"><link rel="prefetch" href="/assets/js/72.8f5a7a45.js"><link rel="prefetch" href="/assets/js/73.e57a96e8.js"><link rel="prefetch" href="/assets/js/74.88747955.js"><link rel="prefetch" href="/assets/js/75.732edfec.js"><link rel="prefetch" href="/assets/js/76.4ca1f9a6.js"><link rel="prefetch" href="/assets/js/77.5c781a7f.js"><link rel="prefetch" href="/assets/js/78.03c79f47.js"><link rel="prefetch" href="/assets/js/79.10a7edb9.js"><link rel="prefetch" href="/assets/js/8.be12edfa.js"><link rel="prefetch" href="/assets/js/80.dcc25a8c.js"><link rel="prefetch" href="/assets/js/81.4f5950c7.js"><link rel="prefetch" href="/assets/js/82.bdb20540.js"><link rel="prefetch" href="/assets/js/83.1feae6d1.js"><link rel="prefetch" href="/assets/js/84.4d61c624.js"><link rel="prefetch" href="/assets/js/85.56c77596.js"><link rel="prefetch" href="/assets/js/86.f354f60e.js"><link rel="prefetch" href="/assets/js/87.c87a28bc.js"><link rel="prefetch" href="/assets/js/88.49d3a2e3.js"><link rel="prefetch" href="/assets/js/89.86033e0e.js"><link rel="prefetch" href="/assets/js/9.740f4ad5.js"><link rel="prefetch" href="/assets/js/90.8a275495.js"><link rel="prefetch" href="/assets/js/91.d964e2b8.js"><link rel="prefetch" href="/assets/js/92.61c34791.js"><link rel="prefetch" href="/assets/js/93.757f983e.js"><link rel="prefetch" href="/assets/js/94.21f343ae.js"><link rel="prefetch" href="/assets/js/95.27d82a02.js"><link rel="prefetch" href="/assets/js/96.4a23e86a.js"><link rel="prefetch" href="/assets/js/97.440bc5c8.js"><link rel="prefetch" href="/assets/js/98.82122a7f.js"><link rel="prefetch" href="/assets/js/99.d4ccc686.js">
    <link rel="stylesheet" href="/assets/css/0.styles.29d22670.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/imgs/logo.png" alt="运维技术笔记" class="logo"> <span class="site-name can-hide">运维技术笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/yunwei/" class="nav-link">运维</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/book/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/more/" class="nav-link">更多</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/zhangst94/zhangst94.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/imgs/t.jpg"> <div class="blogger-info"><h3>Zhang</h3> <span>运维小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/yunwei/" class="nav-link">运维</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/book/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/more/" class="nav-link">更多</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/zhangst94/zhangst94.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>KVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Ansible</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Apache</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tomcat</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker-compose</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Containerd</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dragonfly</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>K8S</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>K8S安装篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4c4cd9/" class="sidebar-link">Kubeadm高可用安装K8s集群1.24</a></li><li><a href="/pages/71fe1b/" aria-current="page" class="active sidebar-link">二进制安装Kubernetesv1.24.2IPv4、IPv6双栈</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_1-1-k8s基础系统环境配置" class="sidebar-link">1.1.k8s基础系统环境配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-2-配置ip" class="sidebar-link">1.2.配置IP</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-3-设置主机名" class="sidebar-link">1.3.设置主机名</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-4-配置yum源" class="sidebar-link">1.4.配置yum源</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-5-安装一些必备工具" class="sidebar-link">1.5.安装一些必备工具</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-6-选择性下载需要工具" class="sidebar-link">1.6.选择性下载需要工具</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-7-关闭防火墙" class="sidebar-link">1.7.关闭防火墙</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-8-关闭selinux" class="sidebar-link">1.8.关闭SELinux</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-9-关闭交换分区" class="sidebar-link">1.9.关闭交换分区</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-10-网络配置-俩种方式二选一" class="sidebar-link">1.10.网络配置（俩种方式二选一）</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-11-进行时间同步-lb除外" class="sidebar-link">1.11.进行时间同步 (lb除外)</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-12-配置ulimit" class="sidebar-link">1.12.配置ulimit</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-13-配置免密登录" class="sidebar-link">1.13.配置免密登录</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-14-添加启用源-lb除外" class="sidebar-link">1.14.添加启用源 (lb除外)</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-15-升级内核至4-18版本以上-lb除外" class="sidebar-link">1.15.升级内核至4.18版本以上 (lb除外)</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-16-安装ipvsadm-lb除外" class="sidebar-link">1.16.安装ipvsadm (lb除外)</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-17-修改内核参数-lb除外" class="sidebar-link">1.17.修改内核参数 (lb除外)</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_1-18-所有节点配置hosts本地解析" class="sidebar-link">1.18.所有节点配置hosts本地解析</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_2-1-所有k8s节点安装containerd作为runtime" class="sidebar-link">2.1.所有k8s节点安装Containerd作为Runtime</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_2-1-1配置containerd所需的模块" class="sidebar-link">2.1.1配置Containerd所需的模块</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_2-1-2加载模块" class="sidebar-link">2.1.2加载模块</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_2-1-3配置containerd所需的内核" class="sidebar-link">2.1.3配置Containerd所需的内核</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_2-1-4创建containerd的配置文件" class="sidebar-link">2.1.4创建Containerd的配置文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_2-1-5启动并设置为开机启动" class="sidebar-link">2.1.5启动并设置为开机启动</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_2-1-6配置crictl客户端连接的运行时位置" class="sidebar-link">2.1.6配置crictl客户端连接的运行时位置</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_2-2-k8s与etcd下载及安装-仅在master01操作" class="sidebar-link">2.2.k8s与etcd下载及安装（仅在master01操作）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_2-2-1解压k8s安装包" class="sidebar-link">2.2.1解压k8s安装包</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_2-2-2查看版本" class="sidebar-link">2.2.2查看版本</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_2-2-3将组件发送至其他k8s节点" class="sidebar-link">2.2.3将组件发送至其他k8s节点</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_2-3创建证书相关文件" class="sidebar-link">2.3创建证书相关文件</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_3-1-生成etcd证书" class="sidebar-link">3.1.生成etcd证书</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-1-1所有master节点创建证书存放目录" class="sidebar-link">3.1.1所有master节点创建证书存放目录</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-1-2master01节点生成etcd证书" class="sidebar-link">3.1.2master01节点生成etcd证书</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-1-3将证书复制到其他节点" class="sidebar-link">3.1.3将证书复制到其他节点</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_3-2-生成k8s相关证书" class="sidebar-link">3.2.生成k8s相关证书</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-2-1所有k8s节点创建证书存放目录" class="sidebar-link">3.2.1所有k8s节点创建证书存放目录</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-2-2master01节点生成k8s证书" class="sidebar-link">3.2.2master01节点生成k8s证书</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-2-3生成apiserver聚合证书" class="sidebar-link">3.2.3生成apiserver聚合证书</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-2-4生成controller-manage的证书" class="sidebar-link">3.2.4生成controller-manage的证书</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-2-5创建kube-proxy证书" class="sidebar-link">3.2.5创建kube-proxy证书</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-2-5创建serviceaccount-key-secret" class="sidebar-link">3.2.5创建ServiceAccount Key ——secret</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-2-6将证书发送到其他master节点" class="sidebar-link">3.2.6将证书发送到其他master节点</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_3-2-7查看证书" class="sidebar-link">3.2.7查看证书</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_4-1-etcd配置" class="sidebar-link">4.1.etcd配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_4-1-1master01配置" class="sidebar-link">4.1.1master01配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_4-1-2master02配置" class="sidebar-link">4.1.2master02配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_4-1-3master03配置" class="sidebar-link">4.1.3master03配置</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_4-2-创建service-所有master节点操作" class="sidebar-link">4.2.创建service（所有master节点操作）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_4-2-1创建etcd-service并启动" class="sidebar-link">4.2.1创建etcd.service并启动</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_4-2-2创建etcd证书目录" class="sidebar-link">4.2.2创建etcd证书目录</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_4-2-3查看etcd状态" class="sidebar-link">4.2.3查看etcd状态</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_5-1在lb01和lb02两台服务器上操作" class="sidebar-link">5.1在lb01和lb02两台服务器上操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_5-1-1安装keepalived和haproxy服务" class="sidebar-link">5.1.1安装keepalived和haproxy服务</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_5-1-2修改haproxy配置文件-两台配置文件一样" class="sidebar-link">5.1.2修改haproxy配置文件（两台配置文件一样）</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_5-1-3lb01配置keepalived-master节点" class="sidebar-link">5.1.3lb01配置keepalived master节点</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_5-1-4lb02配置keepalived-backup节点" class="sidebar-link">5.1.4lb02配置keepalived backup节点</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_5-1-5健康检查脚本配置-两台lb主机" class="sidebar-link">5.1.5健康检查脚本配置（两台lb主机）</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_5-1-6启动服务" class="sidebar-link">5.1.6启动服务</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_5-1-7测试高可用" class="sidebar-link">5.1.7测试高可用</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_6-1-创建apiserver-所有master节点" class="sidebar-link">6.1.创建apiserver（所有master节点）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_6-1-1master01节点配置" class="sidebar-link">6.1.1master01节点配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_6-1-2master02节点配置" class="sidebar-link">6.1.2master02节点配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_6-1-3master03节点配置" class="sidebar-link">6.1.3master03节点配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_6-1-4启动apiserver-所有master节点" class="sidebar-link">6.1.4启动apiserver（所有master节点）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_6-2-配置kube-controller-manager-service" class="sidebar-link">6.2.配置kube-controller-manager service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_6-2-1启动kube-controller-manager-并查看状态" class="sidebar-link">6.2.1启动kube-controller-manager，并查看状态</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_6-3-配置kube-scheduler-service" class="sidebar-link">6.3.配置kube-scheduler service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_6-3-1所有master节点配置-且配置相同" class="sidebar-link">6.3.1所有master节点配置，且配置相同</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_6-3-2启动并查看服务状态" class="sidebar-link">6.3.2启动并查看服务状态</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_7-1在master01上配置" class="sidebar-link">7.1在master01上配置</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_7-2查看集群状态-没问题的话继续后续操作" class="sidebar-link">7.2查看集群状态，没问题的话继续后续操作</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_8-1-在master01上将证书复制到node节点" class="sidebar-link">8.1.在master01上将证书复制到node节点</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_8-2-kubelet配置" class="sidebar-link">8.2.kubelet配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_8-2-1所有k8s节点创建相关目录" class="sidebar-link">8.2.1所有k8s节点创建相关目录</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_8-2-2所有k8s节点创建kubelet的配置文件" class="sidebar-link">8.2.2所有k8s节点创建kubelet的配置文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_8-2-3启动kubelet" class="sidebar-link">8.2.3启动kubelet</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_8-2-4查看集群" class="sidebar-link">8.2.4查看集群</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_8-3-kube-proxy配置" class="sidebar-link">8.3.kube-proxy配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_8-3-1将kubeconfig发送至其他节点" class="sidebar-link">8.3.1将kubeconfig发送至其他节点</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_8-3-2所有k8s节点添加kube-proxy的service文件" class="sidebar-link">8.3.2所有k8s节点添加kube-proxy的service文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_8-3-3所有k8s节点添加kube-proxy的配置" class="sidebar-link">8.3.3所有k8s节点添加kube-proxy的配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_8-3-4启动kube-proxy" class="sidebar-link">8.3.4启动kube-proxy</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_9-1以下步骤只在master01操作" class="sidebar-link">9.1以下步骤只在master01操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_9-1-1更改calico网段" class="sidebar-link">9.1.1更改calico网段</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_9-1-2查看容器状态" class="sidebar-link">9.1.2查看容器状态</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_10-1以下步骤只在master01操作" class="sidebar-link">10.1以下步骤只在master01操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_10-1-1修改文件" class="sidebar-link">10.1.1修改文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_10-1-2安装" class="sidebar-link">10.1.2安装</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_11-1以下步骤只在master01操作" class="sidebar-link">11.1以下步骤只在master01操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_11-1-1安装metrics-server" class="sidebar-link">11.1.1安装Metrics-server</a></li><li class="sidebar-sub-header level3"><a href="/pages/71fe1b/#_11-1-2稍等片刻查看状态" class="sidebar-link">11.1.2稍等片刻查看状态</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_12-1部署pod资源" class="sidebar-link">12.1部署pod资源</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_12-2用pod解析默认命名空间中的kubernetes" class="sidebar-link">12.2用pod解析默认命名空间中的kubernetes</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_12-3测试跨命名空间是否可以解析" class="sidebar-link">12.3测试跨命名空间是否可以解析</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_12-4每个节点都必须要能访问kubernetes的kubernetes-svc-443和kube-dns的service-53" class="sidebar-link">12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_12-5pod和pod之前要能通" class="sidebar-link">12.5Pod和Pod之前要能通</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_12-6创建三个副本-可以看到3个副本分布在不同的节点上-用完可以删了" class="sidebar-link">12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_13-1更改dashboard的svc为nodeport-如果已是请忽略" class="sidebar-link">13.1更改dashboard的svc为NodePort，如果已是请忽略</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_13-2查看端口号" class="sidebar-link">13.2查看端口号</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_13-3创建token" class="sidebar-link">13.3创建token</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_13-3登录dashboard" class="sidebar-link">13.3登录dashboard</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_14-1执行部署" class="sidebar-link">14.1执行部署</a></li><li class="sidebar-sub-header level2"><a href="/pages/71fe1b/#_14-2过滤查看ingress端口" class="sidebar-link">14.2过滤查看ingress端口</a></li></ul></li><li><a href="/pages/87eacd/" class="sidebar-link">k8s证书有效期说明</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S进阶篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S高级篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S运维篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S拓展篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>实践记录</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MYSQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Oracle</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Jenkins</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ZooKeeper</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Kafka</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>mq</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nightingale</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Prometheus</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>VictoriaMetrics</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Zabbix</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Grafana</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>.loki</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Consul</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OpenLDAP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>混沌工程</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/yunwei/#运维" data-v-06225672>运维</a></li><li data-v-06225672><a href="/yunwei/#K8S" data-v-06225672>K8S</a></li><li data-v-06225672><a href="/yunwei/#K8S安装篇" data-v-06225672>K8S安装篇</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/zhangst94" target="_blank" title="作者" class="beLink" data-v-06225672>zhang</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-06-20</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">二进制安装Kubernetesv1.24.2IPv4、IPv6双栈<!----></h1>  <div class="theme-vdoing-content content__default"><p>参考链接：https://github.com/cby-chen/Kubernetes</p> <h1 id="二进制安装kubernetes-k8s-v1-24-2-ipv4-ipv6双栈"><a href="#二进制安装kubernetes-k8s-v1-24-2-ipv4-ipv6双栈" class="header-anchor">#</a> 二进制安装Kubernetes（k8s） v1.24.2 IPv4/IPv6双栈</h1> <h1 id="_1-环境"><a href="#_1-环境" class="header-anchor">#</a> 1.环境</h1> <table><thead><tr><th>主机名称</th> <th></th> <th>说明</th> <th>软件</th></tr></thead> <tbody><tr><td>Master01</td> <td>192.168.200.101</td> <td>master节点</td> <td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br>kubelet、kube-proxy、nfs-client</td></tr> <tr><td>Master02</td> <td>192.168.200.102</td> <td>master节点</td> <td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br>kubelet、kube-proxy、nfs-client</td></tr> <tr><td>Master03</td> <td>192.168.200.103</td> <td>master节点</td> <td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br>kubelet、kube-proxy、nfs-client</td></tr> <tr><td>Node01</td> <td>192.168.200.104</td> <td>node节点</td> <td>kubelet、kube-proxy、nfs-client</td></tr> <tr><td>Node02</td> <td>192.168.200.105</td> <td>node节点</td> <td>kubelet、kube-proxy、nfs-client</td></tr> <tr><td></td> <td>192.168.200.100</td> <td>VIP</td> <td></td></tr></tbody></table> <table><thead><tr><th style="text-align:left;">软件</th> <th style="text-align:left;">版本</th></tr></thead> <tbody><tr><td style="text-align:left;">kernel</td> <td style="text-align:left;">5.18.0-1.el8</td></tr> <tr><td style="text-align:left;">CentOS 8</td> <td style="text-align:left;">v8 或者 v7</td></tr> <tr><td style="text-align:left;">kube-apiserver、kube-controller-manager、kube-scheduler、kubelet、kube-proxy</td> <td style="text-align:left;">v1.24.2</td></tr> <tr><td style="text-align:left;">etcd</td> <td style="text-align:left;">v3.5.4</td></tr> <tr><td style="text-align:left;">containerd</td> <td style="text-align:left;">v1.6.6</td></tr> <tr><td style="text-align:left;">cfssl</td> <td style="text-align:left;">v1.6.1</td></tr> <tr><td style="text-align:left;">cni</td> <td style="text-align:left;">v1.1.1</td></tr> <tr><td style="text-align:left;">crictl</td> <td style="text-align:left;">v1.24.2</td></tr> <tr><td style="text-align:left;">haproxy</td> <td style="text-align:left;">v1.8.27</td></tr> <tr><td style="text-align:left;">keepalived</td> <td style="text-align:left;">v2.1.5</td></tr></tbody></table> <p>网段</p> <p>物理主机：192.168.200.0/24</p> <p>service：10.96.0.0/12</p> <p>pod：172.16.0.0/12</p> <p>建议k8s集群与etcd集群分开安装</p> <h2 id="_1-1-k8s基础系统环境配置"><a href="#_1-1-k8s基础系统环境配置" class="header-anchor">#</a> 1.1.k8s基础系统环境配置</h2> <h3 id="_1-2-配置ip"><a href="#_1-2-配置ip" class="header-anchor">#</a> 1.2.配置IP</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/sysconfig/network-scripts/ifcfg-eth1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_1-3-设置主机名"><a href="#_1-3-设置主机名" class="header-anchor">#</a> 1.3.设置主机名</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>hostnamectl set-hostname master1
hostnamectl set-hostname master2
hostnamectl set-hostname master3
hostnamectl set-hostname node1
hostnamectl set-hostname node2

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_1-4-配置yum源"><a href="#_1-4-配置yum源" class="header-anchor">#</a> 1.4.配置yum源</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 对于 CentOS 7</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org|baseurl=https://mirrors.tuna.tsinghua.edu.cn|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-i.bak</span> <span class="token punctuation">\</span>
         /etc/yum.repos.d/CentOS-*.repo

<span class="token comment"># 对于 CentOS 8</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-i.bak</span> <span class="token punctuation">\</span>
         /etc/yum.repos.d/CentOS-*.repo

<span class="token comment"># 对于私有仓库</span>
<span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org/\$contentdir|baseurl=http://10.0.0.123/centos|g'</span> <span class="token parameter variable">-i.bak</span>  /etc/yum.repos.d/CentOS-*.repo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_1-5-安装一些必备工具"><a href="#_1-5-安装一些必备工具" class="header-anchor">#</a> 1.5.安装一些必备工具</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">wget</span> jq psmisc <span class="token function">vim</span> net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> network-scripts <span class="token function">tar</span> <span class="token function">curl</span> <span class="token parameter variable">-y</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_1-6-选择性下载需要工具"><a href="#_1-6-选择性下载需要工具" class="header-anchor">#</a> 1.6.选择性下载需要工具</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token number">1</span>.下载kubernetes1.24.+的二进制包
github二进制包下载地址：https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.24.md

<span class="token function">wget</span> https://dl.k8s.io/v1.24.2/kubernetes-server-linux-amd64.tar.gz

<span class="token number">2</span>.下载etcdctl二进制包
github二进制包下载地址：https://github.com/etcd-io/etcd/releases

<span class="token function">wget</span> https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz

<span class="token number">3</span>.docker-ce二进制包下载地址
二进制包下载地址：https://download.docker.com/linux/static/stable/x86_64/

这里需要下载20.10.+版本

<span class="token function">wget</span> https://download.docker.com/linux/static/stable/x86_64/docker-20.10.14.tgz

<span class="token number">4</span>.containerd二进制包下载
github下载地址：https://github.com/containerd/containerd/releases

containerd下载时下载带cni插件的二进制包。

<span class="token function">wget</span> https://github.com/containerd/containerd/releases/download/v1.6.6/cri-containerd-cni-1.6.6-linux-amd64.tar.gz

<span class="token number">5</span>.下载cfssl二进制包
github二进制包下载地址：https://github.com/cloudflare/cfssl/releases

<span class="token function">wget</span> https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64
<span class="token function">wget</span> https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64
<span class="token function">wget</span> https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl-certinfo_1.6.1_linux_amd64

<span class="token number">6</span>.cni插件下载
github下载地址：https://github.com/containernetworking/plugins/releases

<span class="token function">wget</span> https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz

<span class="token number">7</span>.crictl客户端二进制下载
github下载：https://github.com/kubernetes-sigs/cri-tools/releases

<span class="token function">wget</span> https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.24.2/crictl-v1.24.2-linux-amd64.tar.gz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="_1-7-关闭防火墙"><a href="#_1-7-关闭防火墙" class="header-anchor">#</a> 1.7.关闭防火墙</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl disable <span class="token parameter variable">--now</span> firewalld
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_1-8-关闭selinux"><a href="#_1-8-关闭selinux" class="header-anchor">#</a> 1.8.关闭SELinux</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>setenforce <span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_1-9-关闭交换分区"><a href="#_1-9-关闭交换分区" class="header-anchor">#</a> 1.9.关闭交换分区</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab
swapoff <span class="token parameter variable">-a</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">vm.swappiness</span><span class="token operator">=</span><span class="token number">0</span>

<span class="token function">cat</span> /etc/fstab
<span class="token comment"># /dev/mapper/centos-swap swap                    swap    defaults        0 0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_1-10-网络配置-俩种方式二选一"><a href="#_1-10-网络配置-俩种方式二选一" class="header-anchor">#</a> 1.10.网络配置（俩种方式二选一）</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 方式一</span>
<span class="token comment"># systemctl disable --now NetworkManager</span>
<span class="token comment"># systemctl start network &amp;&amp; systemctl enable network</span>

<span class="token comment"># 方式二</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/NetworkManager/conf.d/calico.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
[keyfile]
unmanaged-devices=interface-name:cali*;interface-name:tunl*
EOF</span>
systemctl restart NetworkManager
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_1-11-进行时间同步-lb除外"><a href="#_1-11-进行时间同步-lb除外" class="header-anchor">#</a> 1.11.进行时间同步 (lb除外)</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 服务端</span>

yum <span class="token function">install</span> chrony <span class="token parameter variable">-y</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/chrony.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
pool ntp.aliyun.com iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
allow 10.0.0.0/24
local stratum 10
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF</span>

systemctl restart chronyd
systemctl <span class="token builtin class-name">enable</span> chronyd

<span class="token comment"># 客户端</span>

yum <span class="token function">install</span> chrony <span class="token parameter variable">-y</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/chrony.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
pool 192.168.200.101 iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF</span>
<span class="token function">cat</span> /etc/chrony.conf <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span>  <span class="token string">&quot;^#&quot;</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">&quot;^$&quot;</span>
pool <span class="token number">192.168</span>.200.101 iburst
driftfile /var/lib/chrony/drift
makestep <span class="token number">1.0</span> <span class="token number">3</span>
rtcsync
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony

systemctl restart chronyd <span class="token punctuation">;</span> systemctl <span class="token builtin class-name">enable</span> chronyd

<span class="token comment"># 客户端安装一条命令</span>
yum <span class="token function">install</span> chrony <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;s#2.centos.pool.ntp.org#192.168.200.101#g&quot;</span> /etc/chrony.conf <span class="token punctuation">;</span> systemctl restart chronyd <span class="token punctuation">;</span> systemctl <span class="token builtin class-name">enable</span> chronyd


<span class="token comment">#使用客户端进行验证</span>
chronyc sources <span class="token parameter variable">-v</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="_1-12-配置ulimit"><a href="#_1-12-配置ulimit" class="header-anchor">#</a> 1.12.配置ulimit</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-SHn</span> <span class="token number">65535</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/security/limits.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
* soft nofile 655360
* hard nofile 131072
* soft nproc 655350
* hard nproc 655350
* seft memlock unlimited
* hard memlock unlimitedd
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_1-13-配置免密登录"><a href="#_1-13-配置免密登录" class="header-anchor">#</a> 1.13.配置免密登录</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> sshpass
ssh-keygen <span class="token parameter variable">-f</span> /root/.ssh/id_rsa <span class="token parameter variable">-P</span> <span class="token string">''</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token string">&quot;192.168.200.101 192.168.200.102 192.168.200.103 192.168.200.104 192.168.200.105 10.0.0.66 10.0.0.67 10.0.0.68 10.0.0.70 10.0.0.80&quot;</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SSHPASS</span><span class="token operator">=</span><span class="token number">123123</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">HOST</span> <span class="token keyword">in</span> <span class="token variable">$IP</span><span class="token punctuation">;</span><span class="token keyword">do</span>
     sshpass <span class="token parameter variable">-e</span> ssh-copy-id <span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token variable">$HOST</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_1-14-添加启用源-lb除外"><a href="#_1-14-添加启用源-lb除外" class="header-anchor">#</a> 1.14.添加启用源 (lb除外)</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 为 RHEL-8或 CentOS-8配置源</span>
yum <span class="token function">install</span> https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm

<span class="token comment"># 为 RHEL-7 SL-7 或 CentOS-7 安装 ELRepo </span>
yum <span class="token function">install</span> https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm

<span class="token comment"># 查看可用安装包</span>
yum  <span class="token parameter variable">--disablerepo</span><span class="token operator">=</span><span class="token string">&quot;*&quot;</span>  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span><span class="token string">&quot;elrepo-kernel&quot;</span>  list  available
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_1-15-升级内核至4-18版本以上-lb除外"><a href="#_1-15-升级内核至4-18版本以上-lb除外" class="header-anchor">#</a> 1.15.升级内核至4.18版本以上 (lb除外)</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 安装最新的内核</span>
<span class="token comment"># 我这里选择的是稳定版kernel-ml   如需更新长期维护版本kernel-lt  </span>
yum  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel  <span class="token function">install</span>  kernel-ml

<span class="token comment"># 查看已安装那些内核</span>
<span class="token function">rpm</span> <span class="token parameter variable">-qa</span> <span class="token operator">|</span> <span class="token function">grep</span> kernel
kernel-core-4.18.0-358.el8.x86_64
kernel-tools-4.18.0-358.el8.x86_64
kernel-ml-core-5.16.7-1.el8.elrepo.x86_64
kernel-ml-5.16.7-1.el8.elrepo.x86_64
kernel-modules-4.18.0-358.el8.x86_64
kernel-4.18.0-358.el8.x86_64
kernel-tools-libs-4.18.0-358.el8.x86_64
kernel-ml-modules-5.16.7-1.el8.elrepo.x86_64

<span class="token comment"># 查看默认内核</span>
grubby --default-kernel
/boot/vmlinuz-5.16.7-1.el8.elrepo.x86_64


<span class="token comment"># 若不是最新的使用命令设置</span>
grubby --set-default /boot/vmlinuz-「您的内核版本」.x86_64

<span class="token comment"># 重启生效</span>
<span class="token function">reboot</span>


<span class="token comment"># v8 整合命令为：</span>
yum <span class="token function">install</span> https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> yum  <span class="token parameter variable">--disablerepo</span><span class="token operator">=</span><span class="token string">&quot;*&quot;</span>  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span><span class="token string">&quot;elrepo-kernel&quot;</span>  list  available <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> yum  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel  <span class="token function">install</span>  kernel-ml <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> grubby --default-kernel <span class="token punctuation">;</span> <span class="token function">reboot</span>

<span class="token comment"># v7 整合命令为：</span>
yum <span class="token function">install</span> https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> yum  <span class="token parameter variable">--disablerepo</span><span class="token operator">=</span><span class="token string">&quot;*&quot;</span>  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span><span class="token string">&quot;elrepo-kernel&quot;</span>  list  available <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> yum  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel  <span class="token function">install</span>  kernel-ml <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> grubby --set-default <span class="token punctuation">\</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /boot/vmlinuz-* <span class="token operator">|</span> <span class="token function">grep</span> elrepo<span class="token variable">)</span></span> <span class="token punctuation">;</span> grubby --default-kernel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="_1-16-安装ipvsadm-lb除外"><a href="#_1-16-安装ipvsadm-lb除外" class="header-anchor">#</a> 1.16.安装ipvsadm (lb除外)</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> ipvsadm ipset sysstat conntrack libseccomp <span class="token parameter variable">-y</span>

<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/modules-load.d/ipvs.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF 
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
EOF</span>

systemctl restart systemd-modules-load.service

lsmod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-e</span> ip_vs <span class="token parameter variable">-e</span> nf_conntrack
ip_vs_sh               <span class="token number">16384</span>  <span class="token number">0</span>
ip_vs_wrr              <span class="token number">16384</span>  <span class="token number">0</span>
ip_vs_rr               <span class="token number">16384</span>  <span class="token number">0</span>
ip_vs                 <span class="token number">180224</span>  <span class="token number">6</span> ip_vs_rr,ip_vs_sh,ip_vs_wrr
nf_conntrack          <span class="token number">176128</span>  <span class="token number">1</span> ip_vs
nf_defrag_ipv6         <span class="token number">24576</span>  <span class="token number">2</span> nf_conntrack,ip_vs
nf_defrag_ipv4         <span class="token number">16384</span>  <span class="token number">1</span> nf_conntrack
libcrc32c              <span class="token number">16384</span>  <span class="token number">3</span> nf_conntrack,xfs,ip_vs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_1-17-修改内核参数-lb除外"><a href="#_1-17-修改内核参数-lb除外" class="header-anchor">#</a> 1.17.修改内核参数 (lb除外)</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf</span>
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720


net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384

net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
net.ipv6.conf.all.forwarding = 0

EOF</span>

<span class="token function">sysctl</span> <span class="token parameter variable">--system</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_1-18-所有节点配置hosts本地解析"><a href="#_1-18-所有节点配置hosts本地解析" class="header-anchor">#</a> 1.18.所有节点配置hosts本地解析</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span><span class="token string">EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

2408:8207:78cc:5cc1:181c::10 master1
2408:8207:78cc:5cc1:181c::20 master2
2408:8207:78cc:5cc1:181c::30 master3
2408:8207:78cc:5cc1:181c::40 node1
2408:8207:78cc:5cc1:181c::50 node2


192.168.200.101 master1
192.168.200.102 master2
192.168.200.103 master3
192.168.200.104 node1
192.168.200.105 node2
192.168.200.100 lb-vip
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h1 id="_2-k8s基本组件安装"><a href="#_2-k8s基本组件安装" class="header-anchor">#</a> 2.k8s基本组件安装</h1> <h2 id="_2-1-所有k8s节点安装containerd作为runtime"><a href="#_2-1-所有k8s节点安装containerd作为runtime" class="header-anchor">#</a> 2.1.所有k8s节点安装Containerd作为Runtime</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz

<span class="token comment">#创建cni插件所需目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/cni/net.d /opt/cni/bin 
<span class="token comment">#解压cni二进制包</span>
<span class="token function">tar</span> xf cni-plugins-linux-amd64-v1.1.1.tgz <span class="token parameter variable">-C</span> /opt/cni/bin/


<span class="token function">wget</span> https://github.com/containerd/containerd/releases/download/v1.6.6/cri-containerd-cni-1.6.6-linux-amd64.tar.gz

<span class="token comment">#解压</span>
<span class="token function">tar</span> <span class="token parameter variable">-C</span> / <span class="token parameter variable">-xzf</span> cri-containerd-cni-1.6.6-linux-amd64.tar.gz

<span class="token comment">#创建服务启动文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/systemd/system/containerd.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/local/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=infinity
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="_2-1-1配置containerd所需的模块"><a href="#_2-1-1配置containerd所需的模块" class="header-anchor">#</a> 2.1.1配置Containerd所需的模块</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/containerd.conf</span>
overlay
br_netfilter
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-1-2加载模块"><a href="#_2-1-2加载模块" class="header-anchor">#</a> 2.1.2加载模块</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl restart systemd-modules-load.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_2-1-3配置containerd所需的内核"><a href="#_2-1-3配置containerd所需的内核" class="header-anchor">#</a> 2.1.3配置Containerd所需的内核</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/99-kubernetes-cri.conf</span>
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF</span>

<span class="token comment"># 加载内核</span>

<span class="token function">sysctl</span> <span class="token parameter variable">--system</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_2-1-4创建containerd的配置文件"><a href="#_2-1-4创建containerd的配置文件" class="header-anchor">#</a> 2.1.4创建Containerd的配置文件</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/containerd
containerd config default <span class="token operator">|</span> <span class="token function">tee</span> /etc/containerd/config.toml


修改Containerd的配置文件
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g&quot;</span> /etc/containerd/config.toml

<span class="token function">cat</span> /etc/containerd/config.toml <span class="token operator">|</span> <span class="token function">grep</span> SystemdCgroup

<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;s#k8s.gcr.io#registry.cn-hangzhou.aliyuncs.com/chenby#g&quot;</span> /etc/containerd/config.toml

<span class="token function">cat</span> /etc/containerd/config.toml <span class="token operator">|</span> <span class="token function">grep</span> sandbox_image

<span class="token comment"># 找到containerd.runtimes.runc.options，在其下加入SystemdCgroup = true</span>

<span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options<span class="token punctuation">]</span>
              SystemdCgroup <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.cni<span class="token punctuation">]</span>


<span class="token comment"># 将sandbox_image默认地址改为符合版本地址</span>

    sandbox_image <span class="token operator">=</span> <span class="token string">&quot;registry.cn-hangzhou.aliyuncs.com/chenby/pause:3.6&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_2-1-5启动并设置为开机启动"><a href="#_2-1-5启动并设置为开机启动" class="header-anchor">#</a> 2.1.5启动并设置为开机启动</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> containerd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-1-6配置crictl客户端连接的运行时位置"><a href="#_2-1-6配置crictl客户端连接的运行时位置" class="header-anchor">#</a> 2.1.6配置crictl客户端连接的运行时位置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.24.2/crictl-v1.24.2-linux-amd64.tar.gz

<span class="token comment">#解压</span>
<span class="token function">tar</span> xf crictl-v1.24.2-linux-amd64.tar.gz <span class="token parameter variable">-C</span> /usr/bin/
<span class="token comment">#生成配置文件</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/crictl.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF</span>

<span class="token comment">#测试</span>
systemctl restart  containerd
crictl info

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="_2-2-k8s与etcd下载及安装-仅在master01操作"><a href="#_2-2-k8s与etcd下载及安装-仅在master01操作" class="header-anchor">#</a> 2.2.k8s与etcd下载及安装（仅在master01操作）</h2> <h3 id="_2-2-1解压k8s安装包"><a href="#_2-2-1解压k8s安装包" class="header-anchor">#</a> 2.2.1解压k8s安装包</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 下载安装包</span>
<span class="token function">wget</span> https://dl.k8s.io/v1.24.2/kubernetes-server-linux-amd64.tar.gz
<span class="token function">wget</span> https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz

<span class="token comment"># 解压k8s安装文件</span>
<span class="token builtin class-name">cd</span> cby
<span class="token function">tar</span> <span class="token parameter variable">-xf</span> kubernetes-server-linux-amd64.tar.gz  --strip-components<span class="token operator">=</span><span class="token number">3</span> <span class="token parameter variable">-C</span> /usr/local/bin kubernetes/server/bin/kube<span class="token punctuation">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="token punctuation">}</span>

<span class="token comment"># 解压etcd安装文件</span>
<span class="token function">tar</span> <span class="token parameter variable">-xf</span> etcd-v3.5.4-linux-amd64.tar.gz --strip-components<span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">-C</span> /usr/local/bin etcd-v3.5.4-linux-amd64/etcd<span class="token punctuation">{</span>,ctl<span class="token punctuation">}</span>

<span class="token comment"># 查看/usr/local/bin下内容</span>

<span class="token function">ls</span> /usr/local/bin/
containerd  containerd-shim-runc-v1  containerd-stress  critest  ctr   etcdctl  kube-controller-manager  kubelet  kube-scheduler  containerd-shim  containerd-shim-runc-v2  crictl  ctd-decoder  etcd  kube-apiserver  kubectl  kube-proxy


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_2-2-2查看版本"><a href="#_2-2-2查看版本" class="header-anchor">#</a> 2.2.2查看版本</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment">#  kubelet --version</span>
Kubernetes v1.24.2
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># etcdctl version</span>
etcdctl version: <span class="token number">3.5</span>.4
API version: <span class="token number">3.5</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_2-2-3将组件发送至其他k8s节点"><a href="#_2-2-3将组件发送至其他k8s节点" class="header-anchor">#</a> 2.2.3将组件发送至其他k8s节点</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">Master</span><span class="token operator">=</span><span class="token string">'master2 master3'</span>
<span class="token assign-left variable">Work</span><span class="token operator">=</span><span class="token string">'node1 node2 k8s-node03 k8s-node04 k8s-node05'</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$Master</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$NODE</span><span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/kube<span class="token punctuation">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="token punctuation">}</span> <span class="token variable">$NODE</span>:/usr/local/bin/<span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/etcd* <span class="token variable">$NODE</span>:/usr/local/bin/<span class="token punctuation">;</span> <span class="token keyword">done</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$Work</span><span class="token punctuation">;</span> <span class="token keyword">do</span>     <span class="token function">scp</span> /usr/local/bin/kube<span class="token punctuation">{</span>let,-proxy<span class="token punctuation">}</span> <span class="token variable">$NODE</span>:/usr/local/bin/ <span class="token punctuation">;</span> <span class="token keyword">done</span>

<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /opt/cni/bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_2-3创建证书相关文件"><a href="#_2-3创建证书相关文件" class="header-anchor">#</a> 2.3创建证书相关文件</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> pki
<span class="token builtin class-name">cd</span> pki
<span class="token function">cat</span> <span class="token operator">&gt;</span> admin-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;admin&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> ca-config.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;876000h&quot;
    },
    &quot;profiles&quot;: {
      &quot;kubernetes&quot;: {
        &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ],
        &quot;expiry&quot;: &quot;876000h&quot;
      }
    }
  }
}
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> etcd-ca-csr.json  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;etcd&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;etcd&quot;,
      &quot;OU&quot;: &quot;Etcd Security&quot;
    }
  ],
  &quot;ca&quot;: {
    &quot;expiry&quot;: &quot;876000h&quot;
  }
}
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> front-proxy-ca-csr.json  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;kubernetes&quot;,
  &quot;key&quot;: {
     &quot;algo&quot;: &quot;rsa&quot;,
     &quot;size&quot;: 2048
  },
  &quot;ca&quot;: {
    &quot;expiry&quot;: &quot;876000h&quot;
  }
}
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> kubelet-csr.json  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;system:node:\<span class="token variable">$NODE</span>&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:nodes&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> manager-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:kube-controller-manager&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> apiserver-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;kube-apiserver&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;Kubernetes&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF</span>


<span class="token function">cat</span> <span class="token operator">&gt;</span> ca-csr.json   <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;kubernetes&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;Kubernetes&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ],
  &quot;ca&quot;: {
    &quot;expiry&quot;: &quot;876000h&quot;
  }
}
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> etcd-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;etcd&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;etcd&quot;,
      &quot;OU&quot;: &quot;Etcd Security&quot;
    }
  ]
}
EOF</span>


<span class="token function">cat</span> <span class="token operator">&gt;</span> front-proxy-client-csr.json  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;front-proxy-client&quot;,
  &quot;key&quot;: {
     &quot;algo&quot;: &quot;rsa&quot;,
     &quot;size&quot;: 2048
  }
}
EOF</span>


<span class="token function">cat</span> <span class="token operator">&gt;</span> kube-proxy-csr.json  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;system:kube-proxy&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:kube-proxy&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF</span>


<span class="token function">cat</span> <span class="token operator">&gt;</span> scheduler-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Beijing&quot;,
      &quot;L&quot;: &quot;Beijing&quot;,
      &quot;O&quot;: &quot;system:kube-scheduler&quot;,
      &quot;OU&quot;: &quot;Kubernetes-manual&quot;
    }
  ]
}
EOF</span>

<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token function">mkdir</span> bootstrap
<span class="token builtin class-name">cd</span> bootstrap
<span class="token function">cat</span> <span class="token operator">&gt;</span> bootstrap.secret.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
apiVersion: v1
kind: Secret
metadata:
  name: bootstrap-token-c8ad9c
  namespace: kube-system
type: bootstrap.kubernetes.io/token
stringData:
  description: &quot;The default bootstrap token generated by 'kubelet '.&quot;
  token-id: c8ad9c
  token-secret: 2e4d610cf3e7426e
  usage-bootstrap-authentication: &quot;true&quot;
  usage-bootstrap-signing: &quot;true&quot;
  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress
 
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubelet-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:node-bootstrapper
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:default-node-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-autoapprove-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:default-node-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-autoapprove-certificate-rotation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:nodes
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
    verbs:
      - &quot;*&quot;
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: &quot;&quot;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kube-apiserver
EOF</span>


<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token function">mkdir</span> coredns
<span class="token builtin class-name">cd</span> coredns
<span class="token function">cat</span> <span class="token operator">&gt;</span> coredns.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
apiVersion: v1
kind: ServiceAccount
metadata:
  name: coredns
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:coredns
rules:
  - apiGroups:
    - &quot;&quot;
    resources:
    - endpoints
    - services
    - pods
    - namespaces
    verbs:
    - list
    - watch
  - apiGroups:
    - discovery.k8s.io
    resources:
    - endpointslices
    verbs:
    - list
    - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:coredns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:coredns
subjects:
- kind: ServiceAccount
  name: coredns
  namespace: kube-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        errors
        health {
          lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
          fallthrough in-addr.arpa ip6.arpa
        }
        prometheus :9153
        forward . /etc/resolv.conf {
          max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coredns
  namespace: kube-system
  labels:
    k8s-app: kube-dns
    kubernetes.io/name: &quot;CoreDNS&quot;
spec:
  # replicas: not specified here:
  # 1. Default is 1.
  # 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  selector:
    matchLabels:
      k8s-app: kube-dns
  template:
    metadata:
      labels:
        k8s-app: kube-dns
    spec:
      priorityClassName: system-cluster-critical
      serviceAccountName: coredns
      tolerations:
        - key: &quot;CriticalAddonsOnly&quot;
          operator: &quot;Exists&quot;
      nodeSelector:
        kubernetes.io/os: linux
      affinity:
         podAntiAffinity:
           preferredDuringSchedulingIgnoredDuringExecution:
           - weight: 100
             podAffinityTerm:
               labelSelector:
                 matchExpressions:
                   - key: k8s-app
                     operator: In
                     values: [&quot;kube-dns&quot;]
               topologyKey: kubernetes.io/hostname
      containers:
      - name: coredns
        image: registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.6 
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 170Mi
          requests:
            cpu: 100m
            memory: 70Mi
        args: [ &quot;-conf&quot;, &quot;/etc/coredns/Corefile&quot; ]
        volumeMounts:
        - name: config-volume
          mountPath: /etc/coredns
          readOnly: true
        ports:
        - containerPort: 53
          name: dns
          protocol: UDP
        - containerPort: 53
          name: dns-tcp
          protocol: TCP
        - containerPort: 9153
          name: metrics
          protocol: TCP
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - all
          readOnlyRootFilesystem: true
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 60
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /ready
            port: 8181
            scheme: HTTP
      dnsPolicy: Default
      volumes:
        - name: config-volume
          configMap:
            name: coredns
            items:
            - key: Corefile
              path: Corefile
---
apiVersion: v1
kind: Service
metadata:
  name: kube-dns
  namespace: kube-system
  annotations:
    prometheus.io/port: &quot;9153&quot;
    prometheus.io/scrape: &quot;true&quot;
  labels:
    k8s-app: kube-dns
    kubernetes.io/cluster-service: &quot;true&quot;
    kubernetes.io/name: &quot;CoreDNS&quot;
spec:
  selector:
    k8s-app: kube-dns
  clusterIP: 10.96.0.10 
  ports:
  - name: dns
    port: 53
    protocol: UDP
  - name: dns-tcp
    port: 53
    protocol: TCP
  - name: metrics
    port: 9153
    protocol: TCP
EOF</span>


<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token function">mkdir</span> metrics-server
<span class="token builtin class-name">cd</span> metrics-server
<span class="token function">cat</span> <span class="token operator">&gt;</span> metrics-server.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-app: metrics-server
  name: metrics-server
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    k8s-app: metrics-server
    rbac.authorization.k8s.io/aggregate-to-admin: &quot;true&quot;
    rbac.authorization.k8s.io/aggregate-to-edit: &quot;true&quot;
    rbac.authorization.k8s.io/aggregate-to-view: &quot;true&quot;
  name: system:aggregated-metrics-reader
rules:
- apiGroups:
  - metrics.k8s.io
  resources:
  - pods
  - nodes
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    k8s-app: metrics-server
  name: system:metrics-server
rules:
- apiGroups:
  - &quot;&quot;
  resources:
  - pods
  - nodes
  - nodes/stats
  - namespaces
  - configmaps
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    k8s-app: metrics-server
  name: metrics-server-auth-reader
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: extension-apiserver-authentication-reader
subjects:
- kind: ServiceAccount
  name: metrics-server
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    k8s-app: metrics-server
  name: metrics-server:system:auth-delegator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:auth-delegator
subjects:
- kind: ServiceAccount
  name: metrics-server
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    k8s-app: metrics-server
  name: system:metrics-server
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:metrics-server
subjects:
- kind: ServiceAccount
  name: metrics-server
  namespace: kube-system
---
apiVersion: v1
kind: Service
metadata:
  labels:
    k8s-app: metrics-server
  name: metrics-server
  namespace: kube-system
spec:
  ports:
  - name: https
    port: 443
    protocol: TCP
    targetPort: https
  selector:
    k8s-app: metrics-server
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    k8s-app: metrics-server
  name: metrics-server
  namespace: kube-system
spec:
  selector:
    matchLabels:
      k8s-app: metrics-server
  strategy:
    rollingUpdate:
      maxUnavailable: 0
  template:
    metadata:
      labels:
        k8s-app: metrics-server
    spec:
      containers:
      - args:
        - --cert-dir=/tmp
        - --secure-port=4443
        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
        - --kubelet-use-node-status-port
        - --metric-resolution=15s
        - --kubelet-insecure-tls
        - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem # change to front-proxy-ca.crt for kubeadm
        - --requestheader-username-headers=X-Remote-User
        - --requestheader-group-headers=X-Remote-Group
        - --requestheader-extra-headers-prefix=X-Remote-Extra-
        image: registry.cn-beijing.aliyuncs.com/dotbalo/metrics-server:0.5.0
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /livez
            port: https
            scheme: HTTPS
          periodSeconds: 10
        name: metrics-server
        ports:
        - containerPort: 4443
          name: https
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /readyz
            port: https
            scheme: HTTPS
          initialDelaySeconds: 20
          periodSeconds: 10
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
        securityContext:
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
        volumeMounts:
        - mountPath: /tmp
          name: tmp-dir
        - name: ca-ssl
          mountPath: /etc/kubernetes/pki
      nodeSelector:
        kubernetes.io/os: linux
      priorityClassName: system-cluster-critical
      serviceAccountName: metrics-server
      volumes:
      - emptyDir: {}
        name: tmp-dir
      - name: ca-ssl
        hostPath:
          path: /etc/kubernetes/pki

---
apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
  labels:
    k8s-app: metrics-server
  name: v1beta1.metrics.k8s.io
spec:
  group: metrics.k8s.io
  groupPriorityMinimum: 100
  insecureSkipTLSVerify: true
  service:
    name: metrics-server
    namespace: kube-system
  version: v1beta1
  versionPriority: 100
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br><span class="line-number">515</span><br><span class="line-number">516</span><br><span class="line-number">517</span><br><span class="line-number">518</span><br><span class="line-number">519</span><br><span class="line-number">520</span><br><span class="line-number">521</span><br><span class="line-number">522</span><br><span class="line-number">523</span><br><span class="line-number">524</span><br><span class="line-number">525</span><br><span class="line-number">526</span><br><span class="line-number">527</span><br><span class="line-number">528</span><br><span class="line-number">529</span><br><span class="line-number">530</span><br><span class="line-number">531</span><br><span class="line-number">532</span><br><span class="line-number">533</span><br><span class="line-number">534</span><br><span class="line-number">535</span><br><span class="line-number">536</span><br><span class="line-number">537</span><br><span class="line-number">538</span><br><span class="line-number">539</span><br><span class="line-number">540</span><br><span class="line-number">541</span><br><span class="line-number">542</span><br><span class="line-number">543</span><br><span class="line-number">544</span><br><span class="line-number">545</span><br><span class="line-number">546</span><br><span class="line-number">547</span><br><span class="line-number">548</span><br><span class="line-number">549</span><br><span class="line-number">550</span><br><span class="line-number">551</span><br><span class="line-number">552</span><br><span class="line-number">553</span><br><span class="line-number">554</span><br><span class="line-number">555</span><br><span class="line-number">556</span><br><span class="line-number">557</span><br><span class="line-number">558</span><br><span class="line-number">559</span><br><span class="line-number">560</span><br><span class="line-number">561</span><br><span class="line-number">562</span><br><span class="line-number">563</span><br><span class="line-number">564</span><br><span class="line-number">565</span><br><span class="line-number">566</span><br><span class="line-number">567</span><br><span class="line-number">568</span><br><span class="line-number">569</span><br><span class="line-number">570</span><br><span class="line-number">571</span><br><span class="line-number">572</span><br><span class="line-number">573</span><br><span class="line-number">574</span><br><span class="line-number">575</span><br><span class="line-number">576</span><br><span class="line-number">577</span><br><span class="line-number">578</span><br><span class="line-number">579</span><br><span class="line-number">580</span><br><span class="line-number">581</span><br><span class="line-number">582</span><br><span class="line-number">583</span><br><span class="line-number">584</span><br><span class="line-number">585</span><br><span class="line-number">586</span><br><span class="line-number">587</span><br><span class="line-number">588</span><br><span class="line-number">589</span><br><span class="line-number">590</span><br><span class="line-number">591</span><br><span class="line-number">592</span><br><span class="line-number">593</span><br><span class="line-number">594</span><br><span class="line-number">595</span><br><span class="line-number">596</span><br><span class="line-number">597</span><br><span class="line-number">598</span><br><span class="line-number">599</span><br><span class="line-number">600</span><br><span class="line-number">601</span><br><span class="line-number">602</span><br><span class="line-number">603</span><br><span class="line-number">604</span><br><span class="line-number">605</span><br><span class="line-number">606</span><br><span class="line-number">607</span><br><span class="line-number">608</span><br><span class="line-number">609</span><br><span class="line-number">610</span><br><span class="line-number">611</span><br><span class="line-number">612</span><br><span class="line-number">613</span><br><span class="line-number">614</span><br><span class="line-number">615</span><br><span class="line-number">616</span><br><span class="line-number">617</span><br><span class="line-number">618</span><br><span class="line-number">619</span><br><span class="line-number">620</span><br><span class="line-number">621</span><br><span class="line-number">622</span><br><span class="line-number">623</span><br><span class="line-number">624</span><br><span class="line-number">625</span><br><span class="line-number">626</span><br><span class="line-number">627</span><br><span class="line-number">628</span><br><span class="line-number">629</span><br><span class="line-number">630</span><br><span class="line-number">631</span><br><span class="line-number">632</span><br><span class="line-number">633</span><br><span class="line-number">634</span><br><span class="line-number">635</span><br><span class="line-number">636</span><br><span class="line-number">637</span><br><span class="line-number">638</span><br><span class="line-number">639</span><br><span class="line-number">640</span><br><span class="line-number">641</span><br><span class="line-number">642</span><br><span class="line-number">643</span><br><span class="line-number">644</span><br><span class="line-number">645</span><br><span class="line-number">646</span><br><span class="line-number">647</span><br><span class="line-number">648</span><br><span class="line-number">649</span><br><span class="line-number">650</span><br><span class="line-number">651</span><br><span class="line-number">652</span><br><span class="line-number">653</span><br><span class="line-number">654</span><br><span class="line-number">655</span><br><span class="line-number">656</span><br><span class="line-number">657</span><br><span class="line-number">658</span><br><span class="line-number">659</span><br><span class="line-number">660</span><br><span class="line-number">661</span><br><span class="line-number">662</span><br><span class="line-number">663</span><br><span class="line-number">664</span><br><span class="line-number">665</span><br><span class="line-number">666</span><br><span class="line-number">667</span><br><span class="line-number">668</span><br><span class="line-number">669</span><br><span class="line-number">670</span><br><span class="line-number">671</span><br><span class="line-number">672</span><br><span class="line-number">673</span><br><span class="line-number">674</span><br><span class="line-number">675</span><br><span class="line-number">676</span><br><span class="line-number">677</span><br><span class="line-number">678</span><br><span class="line-number">679</span><br><span class="line-number">680</span><br><span class="line-number">681</span><br><span class="line-number">682</span><br><span class="line-number">683</span><br><span class="line-number">684</span><br><span class="line-number">685</span><br><span class="line-number">686</span><br><span class="line-number">687</span><br><span class="line-number">688</span><br><span class="line-number">689</span><br><span class="line-number">690</span><br><span class="line-number">691</span><br><span class="line-number">692</span><br><span class="line-number">693</span><br><span class="line-number">694</span><br><span class="line-number">695</span><br><span class="line-number">696</span><br><span class="line-number">697</span><br><span class="line-number">698</span><br><span class="line-number">699</span><br><span class="line-number">700</span><br><span class="line-number">701</span><br><span class="line-number">702</span><br><span class="line-number">703</span><br><span class="line-number">704</span><br><span class="line-number">705</span><br><span class="line-number">706</span><br><span class="line-number">707</span><br><span class="line-number">708</span><br><span class="line-number">709</span><br><span class="line-number">710</span><br><span class="line-number">711</span><br><span class="line-number">712</span><br><span class="line-number">713</span><br><span class="line-number">714</span><br><span class="line-number">715</span><br><span class="line-number">716</span><br><span class="line-number">717</span><br><span class="line-number">718</span><br><span class="line-number">719</span><br><span class="line-number">720</span><br><span class="line-number">721</span><br><span class="line-number">722</span><br><span class="line-number">723</span><br><span class="line-number">724</span><br><span class="line-number">725</span><br><span class="line-number">726</span><br><span class="line-number">727</span><br><span class="line-number">728</span><br><span class="line-number">729</span><br><span class="line-number">730</span><br><span class="line-number">731</span><br><span class="line-number">732</span><br><span class="line-number">733</span><br><span class="line-number">734</span><br></div></div><h1 id="_3-相关证书生成"><a href="#_3-相关证书生成" class="header-anchor">#</a> 3.相关证书生成</h1> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># master01节点下载证书生成工具</span>
<span class="token comment"># wget &quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64&quot; -O /usr/local/bin/cfssl</span>
<span class="token comment"># wget &quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64&quot; -O /usr/local/bin/cfssljson</span>

<span class="token comment"># 软件包内有</span>
<span class="token function">cp</span> cfssl_1.6.1_linux_amd64 /usr/local/bin/cfssl
<span class="token function">cp</span> cfssljson_1.6.1_linux_amd64 /usr/local/bin/cfssljson

<span class="token function">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_3-1-生成etcd证书"><a href="#_3-1-生成etcd证书" class="header-anchor">#</a> 3.1.生成etcd证书</h2> <p>特别说明除外，以下操作在所有master节点操作</p> <h3 id="_3-1-1所有master节点创建证书存放目录"><a href="#_3-1-1所有master节点创建证书存放目录" class="header-anchor">#</a> 3.1.1所有master节点创建证书存放目录</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> /etc/etcd/ssl <span class="token parameter variable">-p</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_3-1-2master01节点生成etcd证书"><a href="#_3-1-2master01节点生成etcd证书" class="header-anchor">#</a> 3.1.2master01节点生成etcd证书</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> pki

<span class="token comment"># 生成etcd证书和etcd证书的key（如果你觉得以后可能会扩容，可以在ip那多写几个预留出来）</span>

cfssl gencert <span class="token parameter variable">-initca</span> etcd-ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/etcd/ssl/etcd-ca

cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1,master1,master2,master3,192.168.200.101,192.168.200.102,192.168.200.103 <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   etcd-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/etcd/ssl/etcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_3-1-3将证书复制到其他节点"><a href="#_3-1-3将证书复制到其他节点" class="header-anchor">#</a> 3.1.3将证书复制到其他节点</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">Master</span><span class="token operator">=</span><span class="token string">'master2 master3'</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$Master</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token string">&quot;mkdir -p /etc/etcd/ssl&quot;</span><span class="token punctuation">;</span> <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">scp</span> /etc/etcd/ssl/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/etcd/ssl/<span class="token variable">${FILE}</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_3-2-生成k8s相关证书"><a href="#_3-2-生成k8s相关证书" class="header-anchor">#</a> 3.2.生成k8s相关证书</h2> <p>特别说明除外，以下操作在所有master节点操作</p> <h3 id="_3-2-1所有k8s节点创建证书存放目录"><a href="#_3-2-1所有k8s节点创建证书存放目录" class="header-anchor">#</a> 3.2.1所有k8s节点创建证书存放目录</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/pki
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_3-2-2master01节点生成k8s证书"><a href="#_3-2-2master01节点生成k8s证书" class="header-anchor">#</a> 3.2.2master01节点生成k8s证书</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>cfssl gencert <span class="token parameter variable">-initca</span> ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/ca

<span class="token comment"># 生成一个根证书 ，多写了一些IP作为预留IP，为将来添加node做准备</span>
<span class="token comment"># 10.96.0.1是service网段的第一个地址，需要计算，192.168.200.100为高可用vip地址</span>

cfssl gencert   <span class="token punctuation">\</span>
<span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem   <span class="token punctuation">\</span>
-ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem   <span class="token punctuation">\</span>
<span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json   <span class="token punctuation">\</span>
<span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">10.96</span>.0.1,192.168.200.100,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,x.oiox.cn,k.oiox.cn,l.oiox.cn,o.oiox.cn,192.168.200.101,192.168.200.102,192.168.200.103,192.168.200.104,192.168.200.105  <span class="token punctuation">\</span>
<span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes   apiserver-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-2-3生成apiserver聚合证书"><a href="#_3-2-3生成apiserver聚合证书" class="header-anchor">#</a> 3.2.3生成apiserver聚合证书</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>cfssl gencert   <span class="token parameter variable">-initca</span> front-proxy-ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/front-proxy-ca 

<span class="token comment"># 有一个警告，可以忽略</span>

cfssl gencert  <span class="token punctuation">\</span>
<span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem   <span class="token punctuation">\</span>
-ca-key<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem   <span class="token punctuation">\</span>
<span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json   <span class="token punctuation">\</span>
<span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes   front-proxy-client-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/front-proxy-client
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_3-2-4生成controller-manage的证书"><a href="#_3-2-4生成controller-manage的证书" class="header-anchor">#</a> 3.2.4生成controller-manage的证书</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   manager-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/controller-manager

<span class="token comment"># 设置一个集群项</span>

kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.200.100:8443 <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig

<span class="token comment"># 设置一个环境项，一个上下文</span>

kubectl config set-context system:kube-controller-manager@kubernetes <span class="token punctuation">\</span>
    <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
    <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-controller-manager <span class="token punctuation">\</span>
    <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig

<span class="token comment"># 设置一个用户项</span>

kubectl config set-credentials system:kube-controller-manager <span class="token punctuation">\</span>
     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager.pem <span class="token punctuation">\</span>
     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig

<span class="token comment"># 设置默认环境</span>

kubectl config use-context system:kube-controller-manager@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig

cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   scheduler-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/scheduler

kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.200.100:8443 <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config set-credentials system:kube-scheduler <span class="token punctuation">\</span>
     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/scheduler.pem <span class="token punctuation">\</span>
     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/scheduler-key.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config set-context system:kube-scheduler@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-scheduler <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config use-context system:kube-scheduler@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   admin-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/admin

kubectl config set-cluster kubernetes     <span class="token punctuation">\</span>
  --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true     <span class="token punctuation">\</span>
  <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.200.100:8443     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig

kubectl config set-credentials kubernetes-admin  <span class="token punctuation">\</span>
  --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/admin.pem     <span class="token punctuation">\</span>
  --client-key<span class="token operator">=</span>/etc/kubernetes/pki/admin-key.pem     <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig

kubectl config set-context kubernetes-admin@kubernetes    <span class="token punctuation">\</span>
  <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token punctuation">\</span>
  <span class="token parameter variable">--user</span><span class="token operator">=</span>kubernetes-admin     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig

kubectl config use-context kubernetes-admin@kubernetes  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><h3 id="_3-2-5创建kube-proxy证书"><a href="#_3-2-5创建kube-proxy证书" class="header-anchor">#</a> 3.2.5创建kube-proxy证书</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   kube-proxy-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/kube-proxy
   
kubectl config set-cluster kubernetes     <span class="token punctuation">\</span>
  --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true     <span class="token punctuation">\</span>
  <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.200.100:8443     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig

kubectl config set-credentials kube-proxy  <span class="token punctuation">\</span>
  --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/kube-proxy.pem     <span class="token punctuation">\</span>
  --client-key<span class="token operator">=</span>/etc/kubernetes/pki/kube-proxy-key.pem     <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig

kubectl config set-context kube-proxy@kubernetes    <span class="token punctuation">\</span>
  <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token punctuation">\</span>
  <span class="token parameter variable">--user</span><span class="token operator">=</span>kube-proxy     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig

kubectl config use-context kube-proxy@kubernetes  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_3-2-5创建serviceaccount-key-secret"><a href="#_3-2-5创建serviceaccount-key-secret" class="header-anchor">#</a> 3.2.5创建ServiceAccount Key ——secret</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl genrsa <span class="token parameter variable">-out</span> /etc/kubernetes/pki/sa.key <span class="token number">2048</span>
openssl rsa <span class="token parameter variable">-in</span> /etc/kubernetes/pki/sa.key <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> /etc/kubernetes/pki/sa.pub
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_3-2-6将证书发送到其他master节点"><a href="#_3-2-6将证书发送到其他master节点" class="header-anchor">#</a> 3.2.6将证书发送到其他master节点</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#其他节点创建目录</span>
<span class="token comment"># mkdir  /etc/kubernetes/pki/ -p</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> master2 master3<span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /etc/kubernetes/pki <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> etcd<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token function">scp</span> /etc/kubernetes/pki/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/pki/<span class="token variable">${FILE}</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token function">scp</span> /etc/kubernetes/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_3-2-7查看证书"><a href="#_3-2-7查看证书" class="header-anchor">#</a> 3.2.7查看证书</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">ls</span> /etc/kubernetes/pki/
admin.csr          ca.csr                      front-proxy-ca.csr          kube-proxy.csr      scheduler-key.pem
admin-key.pem      ca-key.pem                  front-proxy-ca-key.pem      kube-proxy-key.pem  scheduler.pem
admin.pem          ca.pem                      front-proxy-ca.pem          kube-proxy.pem
apiserver.csr      controller-manager.csr      front-proxy-client.csr      sa.key
apiserver-key.pem  controller-manager-key.pem  front-proxy-client-key.pem  sa.pub
apiserver.pem      controller-manager.pem      front-proxy-client.pem      scheduler.csr

<span class="token comment"># 一共26个就对了</span>

<span class="token function">ls</span> /etc/kubernetes/pki/ <span class="token operator">|</span><span class="token function">wc</span> <span class="token parameter variable">-l</span>
<span class="token number">26</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h1 id="_4-k8s系统组件配置"><a href="#_4-k8s系统组件配置" class="header-anchor">#</a> 4.k8s系统组件配置</h1> <h2 id="_4-1-etcd配置"><a href="#_4-1-etcd配置" class="header-anchor">#</a> 4.1.etcd配置</h2> <h3 id="_4-1-1master01配置"><a href="#_4-1-1master01配置" class="header-anchor">#</a> 4.1.1master01配置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/etcd/etcd.config.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
name: 'master1'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.200.101:2380'
listen-client-urls: 'https://192.168.200.101:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.200.101:2380'
advertise-client-urls: 'https://192.168.200.101:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'master1=https://192.168.200.101:2380,master2=https://192.168.200.102:2380,master3=https://192.168.200.103:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="_4-1-2master02配置"><a href="#_4-1-2master02配置" class="header-anchor">#</a> 4.1.2master02配置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/etcd/etcd.config.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
name: 'master2'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.200.102:2380'
listen-client-urls: 'https://192.168.200.102:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.200.102:2380'
advertise-client-urls: 'https://192.168.200.102:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'master1=https://192.168.200.101:2380,master2=https://192.168.200.102:2380,master3=https://192.168.200.103:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="_4-1-3master03配置"><a href="#_4-1-3master03配置" class="header-anchor">#</a> 4.1.3master03配置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/etcd/etcd.config.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
name: 'master3'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.200.103:2380'
listen-client-urls: 'https://192.168.200.103:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.200.103:2380'
advertise-client-urls: 'https://192.168.200.103:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'master1=https://192.168.200.101:2380,master2=https://192.168.200.102:2380,master3=https://192.168.200.103:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h2 id="_4-2-创建service-所有master节点操作"><a href="#_4-2-创建service-所有master节点操作" class="header-anchor">#</a> 4.2.创建service（所有master节点操作）</h2> <h3 id="_4-2-1创建etcd-service并启动"><a href="#_4-2-1创建etcd-service并启动" class="header-anchor">#</a> 4.2.1创建etcd.service并启动</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/etcd.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Etcd Service
Documentation=https://coreos.com/etcd/docs/latest/
After=network.target

[Service]
Type=notify
ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml
Restart=on-failure
RestartSec=10
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
Alias=etcd3.service

EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_4-2-2创建etcd证书目录"><a href="#_4-2-2创建etcd证书目录" class="header-anchor">#</a> 4.2.2创建etcd证书目录</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> /etc/kubernetes/pki/etcd
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> etcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_4-2-3查看etcd状态"><a href="#_4-2-3查看etcd状态" class="header-anchor">#</a> 4.2.3查看etcd状态</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span>
etcdctl <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;192.168.200.103:2379,192.168.200.102:2379,192.168.200.101:2379&quot;</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem <span class="token parameter variable">--cert</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd.pem <span class="token parameter variable">--key</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out<span class="token operator">=</span>table
+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<span class="token operator">|</span>    ENDPOINT    <span class="token operator">|</span>        ID        <span class="token operator">|</span> VERSION <span class="token operator">|</span> DB SIZE <span class="token operator">|</span> IS LEADER <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span> RAFT <span class="token environment constant">TERM</span> <span class="token operator">|</span> RAFT INDEX <span class="token operator">|</span> RAFT APPLIED INDEX <span class="token operator">|</span> ERRORS <span class="token operator">|</span>
+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<span class="token operator">|</span> <span class="token number">192.168</span>.200.103:2379 <span class="token operator">|</span> c0c8142615b9523f <span class="token operator">|</span>   <span class="token number">3.5</span>.4 <span class="token operator">|</span>   <span class="token number">20</span> kB <span class="token operator">|</span>     <span class="token boolean">false</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>          <span class="token number">9</span> <span class="token operator">|</span>                  <span class="token number">9</span> <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">192.168</span>.200.102:2379 <span class="token operator">|</span> de8396604d2c160d <span class="token operator">|</span>   <span class="token number">3.5</span>.4 <span class="token operator">|</span>   <span class="token number">20</span> kB <span class="token operator">|</span>     <span class="token boolean">false</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>          <span class="token number">9</span> <span class="token operator">|</span>                  <span class="token number">9</span> <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">192.168</span>.200.101:2379 <span class="token operator">|</span> 33c9d6df0037ab97 <span class="token operator">|</span>   <span class="token number">3.5</span>.4 <span class="token operator">|</span>   <span class="token number">20</span> kB <span class="token operator">|</span>      <span class="token boolean">true</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>          <span class="token number">9</span> <span class="token operator">|</span>                  <span class="token number">9</span> <span class="token operator">|</span>        <span class="token operator">|</span>
+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+

<span class="token punctuation">[</span>root@master1 pki<span class="token punctuation">]</span><span class="token comment"># </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h1 id="_5-高可用配置"><a href="#_5-高可用配置" class="header-anchor">#</a> 5.高可用配置</h1> <h2 id="_5-1在lb01和lb02两台服务器上操作"><a href="#_5-1在lb01和lb02两台服务器上操作" class="header-anchor">#</a> 5.1在lb01和lb02两台服务器上操作</h2> <h3 id="_5-1-1安装keepalived和haproxy服务"><a href="#_5-1-1安装keepalived和haproxy服务" class="header-anchor">#</a> 5.1.1安装keepalived和haproxy服务</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl disable <span class="token parameter variable">--now</span> firewalld

setenforce <span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config

yum <span class="token parameter variable">-y</span> <span class="token function">install</span> keepalived haproxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_5-1-2修改haproxy配置文件-两台配置文件一样"><a href="#_5-1-2修改haproxy配置文件-两台配置文件一样" class="header-anchor">#</a> 5.1.2修改haproxy配置文件（两台配置文件一样）</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span>/etc/haproxy/haproxy.cfg<span class="token operator">&lt;&lt;</span><span class="token string">&quot;EOF&quot;
global
 maxconn 2000
 ulimit-n 16384
 log 127.0.0.1 local0 err
 stats timeout 30s

defaults
 log global
 mode http
 option httplog
 timeout connect 5000
 timeout client 50000
 timeout server 50000
 timeout http-request 15s
 timeout http-keep-alive 15s


frontend monitor-in
 bind *:33305
 mode http
 option httplog
 monitor-uri /monitor

frontend k8s-master
 bind 0.0.0.0:8443
 bind 127.0.0.1:8443
 mode tcp
 option tcplog
 tcp-request inspect-delay 5s
 default_backend k8s-master


backend k8s-master
 mode tcp
 option tcplog
 option tcp-check
 balance roundrobin
 default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
 server  master1  192.168.200.101:6443 check
 server  master2  192.168.200.102:6443 check
 server  master3  192.168.200.103:6443 check
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="_5-1-3lb01配置keepalived-master节点"><a href="#_5-1-3lb01配置keepalived-master节点" class="header-anchor">#</a> 5.1.3lb01配置keepalived master节点</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/keepalived/keepalived.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script &quot;/etc/keepalived/check_apiserver.sh&quot;
    interval 5 
    weight -5
    fall 2
    rise 1
}
vrrp_instance VI_1 {
    state MASTER
    # 注意网卡名
    interface ens160 
    mcast_src_ip 10.0.0.70
    virtual_router_id 51
    priority 100
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.200.100
    }
    track_script {
      chk_apiserver 
} }

EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="_5-1-4lb02配置keepalived-backup节点"><a href="#_5-1-4lb02配置keepalived-backup节点" class="header-anchor">#</a> 5.1.4lb02配置keepalived backup节点</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/keepalived/keepalived.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script &quot;/etc/keepalived/check_apiserver.sh&quot;
    interval 5 
    weight -5
    fall 2
    rise 1

}
vrrp_instance VI_1 {
    state BACKUP
    # 注意网卡名
    interface ens160
    mcast_src_ip 10.0.0.80
    virtual_router_id 51
    priority 50
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.200.100
    }
    track_script {
      chk_apiserver 
} }

EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="_5-1-5健康检查脚本配置-两台lb主机"><a href="#_5-1-5健康检查脚本配置-两台lb主机" class="header-anchor">#</a> 5.1.5健康检查脚本配置（两台lb主机）</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span>  /etc/keepalived/check_apiserver.sh <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/bin/bash

err=0
for k in \<span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">3</span><span class="token variable">)</span></span>
do
    check_code=\<span class="token variable"><span class="token variable">$(</span>pgrep haproxy<span class="token variable">)</span></span>
    if [[ \<span class="token variable">$check_code</span> == &quot;&quot; ]]; then
        err=\<span class="token variable"><span class="token variable">$(</span><span class="token function">expr</span> <span class="token punctuation">\</span>$err + <span class="token number">1</span><span class="token variable">)</span></span>
        sleep 1
        continue
    else
        err=0
        break
    fi
done

if [[ \<span class="token variable">$err</span> != &quot;0&quot; ]]; then
    echo &quot;systemctl stop keepalived&quot;
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi
EOF</span>

<span class="token comment"># 给脚本授权</span>

<span class="token function">chmod</span> +x /etc/keepalived/check_apiserver.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="_5-1-6启动服务"><a href="#_5-1-6启动服务" class="header-anchor">#</a> 5.1.6启动服务</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> haproxy
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> keepalived
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_5-1-7测试高可用"><a href="#_5-1-7测试高可用" class="header-anchor">#</a> 5.1.7测试高可用</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 能ping同</span>

<span class="token punctuation">[</span>root@node2 ~<span class="token punctuation">]</span><span class="token comment"># ping 192.168.200.100</span>

<span class="token comment"># 能telnet访问</span>

<span class="token punctuation">[</span>root@node2 ~<span class="token punctuation">]</span><span class="token comment"># telnet 192.168.200.100 8443</span>

<span class="token comment"># 关闭主节点，看vip是否漂移到备节点</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h1 id="_6-k8s组件配置-区别于第4点"><a href="#_6-k8s组件配置-区别于第4点" class="header-anchor">#</a> 6.k8s组件配置（区别于第4点）</h1> <p>所有k8s节点创建以下目录</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_6-1-创建apiserver-所有master节点"><a href="#_6-1-创建apiserver-所有master节点" class="header-anchor">#</a> 6.1.创建apiserver（所有master节点）</h2> <h3 id="_6-1-1master01节点配置"><a href="#_6-1-1master01节点配置" class="header-anchor">#</a> 6.1.1master01节点配置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver <span class="token entity" title="\\">\\</span>
      --v=2  <span class="token entity" title="\\">\\</span>
      --logtostderr=true  <span class="token entity" title="\\">\\</span>
      --allow-privileged=true  <span class="token entity" title="\\">\\</span>
      --bind-address=0.0.0.0  <span class="token entity" title="\\">\\</span>
      --secure-port=6443  <span class="token entity" title="\\">\\</span>
      --advertise-address=192.168.200.101 <span class="token entity" title="\\">\\</span>
      --service-cluster-ip-range=10.96.0.0/12,fd00::/108  <span class="token entity" title="\\">\\</span>
      --feature-gates=IPv6DualStack=true  <span class="token entity" title="\\">\\</span>
      --service-node-port-range=30000-32767  <span class="token entity" title="\\">\\</span>
      --etcd-servers=https://192.168.200.101:2379,https://192.168.200.102:2379,https://192.168.200.103:2379 <span class="token entity" title="\\">\\</span>
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  <span class="token entity" title="\\">\\</span>
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  <span class="token entity" title="\\">\\</span>
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  <span class="token entity" title="\\">\\</span>
      --client-ca-file=/etc/kubernetes/pki/ca.pem  <span class="token entity" title="\\">\\</span>
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  <span class="token entity" title="\\">\\</span>
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  <span class="token entity" title="\\">\\</span>
      --service-account-issuer=https://kubernetes.default.svc.cluster.local <span class="token entity" title="\\">\\</span>
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  <span class="token entity" title="\\">\\</span>
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
      --authorization-mode=Node,RBAC  <span class="token entity" title="\\">\\</span>
      --enable-bootstrap-token-auth=true  <span class="token entity" title="\\">\\</span>
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token entity" title="\\">\\</span>
      --requestheader-allowed-names=aggregator  <span class="token entity" title="\\">\\</span>
      --requestheader-group-headers=X-Remote-Group  <span class="token entity" title="\\">\\</span>
      --requestheader-extra-headers-prefix=X-Remote-Extra-  <span class="token entity" title="\\">\\</span>
      --requestheader-username-headers=X-Remote-User <span class="token entity" title="\\">\\</span>
      --enable-aggregator-routing=true
      # --token-auth-file=/etc/kubernetes/token.csv

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="_6-1-2master02节点配置"><a href="#_6-1-2master02节点配置" class="header-anchor">#</a> 6.1.2master02节点配置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver <span class="token entity" title="\\">\\</span>
      --v=2  <span class="token entity" title="\\">\\</span>
      --logtostderr=true  <span class="token entity" title="\\">\\</span>
      --allow-privileged=true  <span class="token entity" title="\\">\\</span>
      --bind-address=0.0.0.0  <span class="token entity" title="\\">\\</span>
      --secure-port=6443  <span class="token entity" title="\\">\\</span>
      --advertise-address=192.168.200.102 <span class="token entity" title="\\">\\</span>
      --service-cluster-ip-range=10.96.0.0/12,fd00::/108  <span class="token entity" title="\\">\\</span>
      --feature-gates=IPv6DualStack=true <span class="token entity" title="\\">\\</span>
      --service-node-port-range=30000-32767  <span class="token entity" title="\\">\\</span>
      --etcd-servers=https://192.168.200.101:2379,https://192.168.200.102:2379,https://192.168.200.103:2379 <span class="token entity" title="\\">\\</span>
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  <span class="token entity" title="\\">\\</span>
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  <span class="token entity" title="\\">\\</span>
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  <span class="token entity" title="\\">\\</span>
      --client-ca-file=/etc/kubernetes/pki/ca.pem  <span class="token entity" title="\\">\\</span>
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  <span class="token entity" title="\\">\\</span>
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  <span class="token entity" title="\\">\\</span>
      --service-account-issuer=https://kubernetes.default.svc.cluster.local <span class="token entity" title="\\">\\</span>
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  <span class="token entity" title="\\">\\</span>
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token entity" title="\\">\\</span>
      --authorization-mode=Node,RBAC  <span class="token entity" title="\\">\\</span>
      --enable-bootstrap-token-auth=true  <span class="token entity" title="\\">\\</span>
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token entity" title="\\">\\</span>
      --requestheader-allowed-names=aggregator  <span class="token entity" title="\\">\\</span>
      --requestheader-group-headers=X-Remote-Group  <span class="token entity" title="\\">\\</span>
      --requestheader-extra-headers-prefix=X-Remote-Extra-  <span class="token entity" title="\\">\\</span>
      --requestheader-username-headers=X-Remote-User <span class="token entity" title="\\">\\</span>
      --enable-aggregator-routing=true
      # --token-auth-file=/etc/kubernetes/token.csv

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h3 id="_6-1-3master03节点配置"><a href="#_6-1-3master03节点配置" class="header-anchor">#</a> 6.1.3master03节点配置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver <span class="token entity" title="\\">\\</span>
      --v=2  <span class="token entity" title="\\">\\</span>
      --logtostderr=true  <span class="token entity" title="\\">\\</span>
      --allow-privileged=true  <span class="token entity" title="\\">\\</span>
      --bind-address=0.0.0.0  <span class="token entity" title="\\">\\</span>
      --secure-port=6443  <span class="token entity" title="\\">\\</span>
      --advertise-address=192.168.200.103 <span class="token entity" title="\\">\\</span>
      --service-cluster-ip-range=10.96.0.0/12,fd00::/108  <span class="token entity" title="\\">\\</span>
      --feature-gates=IPv6DualStack=true <span class="token entity" title="\\">\\</span>
      --service-node-port-range=30000-32767  <span class="token entity" title="\\">\\</span>
      --etcd-servers=https://192.168.200.101:2379,https://192.168.200.102:2379,https://192.168.200.103:2379 <span class="token entity" title="\\">\\</span>
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  <span class="token entity" title="\\">\\</span>
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  <span class="token entity" title="\\">\\</span>
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  <span class="token entity" title="\\">\\</span>
      --client-ca-file=/etc/kubernetes/pki/ca.pem  <span class="token entity" title="\\">\\</span>
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  <span class="token entity" title="\\">\\</span>
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  <span class="token entity" title="\\">\\</span>
      --service-account-issuer=https://kubernetes.default.svc.cluster.local <span class="token entity" title="\\">\\</span>
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  <span class="token entity" title="\\">\\</span>
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token entity" title="\\">\\</span>
      --authorization-mode=Node,RBAC  <span class="token entity" title="\\">\\</span>
      --enable-bootstrap-token-auth=true  <span class="token entity" title="\\">\\</span>
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token entity" title="\\">\\</span>
      --requestheader-allowed-names=aggregator  <span class="token entity" title="\\">\\</span>
      --requestheader-group-headers=X-Remote-Group  <span class="token entity" title="\\">\\</span>
      --requestheader-extra-headers-prefix=X-Remote-Extra-  <span class="token entity" title="\\">\\</span>
      --requestheader-username-headers=X-Remote-User <span class="token entity" title="\\">\\</span>
      --enable-aggregator-routing=true

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h3 id="_6-1-4启动apiserver-所有master节点"><a href="#_6-1-4启动apiserver-所有master节点" class="header-anchor">#</a> 6.1.4启动apiserver（所有master节点）</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-apiserver

<span class="token comment"># 注意查看状态是否启动正常</span>

systemctl status kube-apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_6-2-配置kube-controller-manager-service"><a href="#_6-2-配置kube-controller-manager-service" class="header-anchor">#</a> 6.2.配置kube-controller-manager service</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 所有master节点配置，且配置相同</span>
<span class="token comment"># 172.16.0.0/12为pod网段，按需求设置你自己的网段</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-controller-manager.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-controller-manager <span class="token entity" title="\\">\\</span>
      --v=2 <span class="token entity" title="\\">\\</span>
      --logtostderr=true <span class="token entity" title="\\">\\</span>
      --bind-address=127.0.0.1 <span class="token entity" title="\\">\\</span>
      --root-ca-file=/etc/kubernetes/pki/ca.pem <span class="token entity" title="\\">\\</span>
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem <span class="token entity" title="\\">\\</span>
      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem <span class="token entity" title="\\">\\</span>
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key <span class="token entity" title="\\">\\</span>
      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig <span class="token entity" title="\\">\\</span>
      --leader-elect=true <span class="token entity" title="\\">\\</span>
      --use-service-account-credentials=true <span class="token entity" title="\\">\\</span>
      --node-monitor-grace-period=40s <span class="token entity" title="\\">\\</span>
      --node-monitor-period=5s <span class="token entity" title="\\">\\</span>
      --pod-eviction-timeout=2m0s <span class="token entity" title="\\">\\</span>
      --controllers=*,bootstrapsigner,tokencleaner <span class="token entity" title="\\">\\</span>
      --allocate-node-cidrs=true <span class="token entity" title="\\">\\</span>
      --feature-gates=IPv6DualStack=true <span class="token entity" title="\\">\\</span>
      --service-cluster-ip-range=10.96.0.0/12,fd00::/108 <span class="token entity" title="\\">\\</span>
      --cluster-cidr=172.16.0.0/12,fc00::/48 <span class="token entity" title="\\">\\</span>
      --node-cidr-mask-size-ipv4=24 <span class="token entity" title="\\">\\</span>
      --node-cidr-mask-size-ipv6=64 <span class="token entity" title="\\">\\</span>
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem 

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="_6-2-1启动kube-controller-manager-并查看状态"><a href="#_6-2-1启动kube-controller-manager-并查看状态" class="header-anchor">#</a> 6.2.1启动kube-controller-manager，并查看状态</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-controller-manager
systemctl  status kube-controller-manager
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_6-3-配置kube-scheduler-service"><a href="#_6-3-配置kube-scheduler-service" class="header-anchor">#</a> 6.3.配置kube-scheduler service</h2> <h3 id="_6-3-1所有master节点配置-且配置相同"><a href="#_6-3-1所有master节点配置-且配置相同" class="header-anchor">#</a> 6.3.1所有master节点配置，且配置相同</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-scheduler.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-scheduler <span class="token entity" title="\\">\\</span>
      --v=2 <span class="token entity" title="\\">\\</span>
      --logtostderr=true <span class="token entity" title="\\">\\</span>
      --bind-address=127.0.0.1 <span class="token entity" title="\\">\\</span>
      --leader-elect=true <span class="token entity" title="\\">\\</span>
      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_6-3-2启动并查看服务状态"><a href="#_6-3-2启动并查看服务状态" class="header-anchor">#</a> 6.3.2启动并查看服务状态</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-scheduler
systemctl status kube-scheduler
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h1 id="_7-tls-bootstrapping配置"><a href="#_7-tls-bootstrapping配置" class="header-anchor">#</a> 7.TLS Bootstrapping配置</h1> <h2 id="_7-1在master01上配置"><a href="#_7-1在master01上配置" class="header-anchor">#</a> 7.1在master01上配置</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> bootstrap

kubectl config set-cluster kubernetes     <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.200.100:8443     <span class="token punctuation">\</span>
<span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config set-credentials tls-bootstrap-token-user     <span class="token punctuation">\</span>
<span class="token parameter variable">--token</span><span class="token operator">=</span>c8ad9c.2e4d610cf3e7426e <span class="token punctuation">\</span>
<span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config set-context tls-bootstrap-token-user@kubernetes     <span class="token punctuation">\</span>
<span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token punctuation">\</span>
<span class="token parameter variable">--user</span><span class="token operator">=</span>tls-bootstrap-token-user     <span class="token punctuation">\</span>
<span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config use-context tls-bootstrap-token-user@kubernetes     <span class="token punctuation">\</span>
<span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

<span class="token comment"># token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span>

<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /root/.kube <span class="token punctuation">;</span> <span class="token function">cp</span> /etc/kubernetes/admin.kubeconfig /root/.kube/config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="_7-2查看集群状态-没问题的话继续后续操作"><a href="#_7-2查看集群状态-没问题的话继续后续操作" class="header-anchor">#</a> 7.2查看集群状态，没问题的话继续后续操作</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl get cs

Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE                         ERROR
scheduler            Healthy   ok                              
controller-manager   Healthy   ok                              
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span>,<span class="token string">&quot;reason&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>   
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span>,<span class="token string">&quot;reason&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>   
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span>,<span class="token string">&quot;reason&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span> 

<span class="token comment"># 切记执行，别忘记！！！</span>

kubectl create <span class="token parameter variable">-f</span> bootstrap.secret.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h1 id="_8-node节点配置"><a href="#_8-node节点配置" class="header-anchor">#</a> 8.node节点配置</h1> <h2 id="_8-1-在master01上将证书复制到node节点"><a href="#_8-1-在master01上将证书复制到node节点" class="header-anchor">#</a> 8.1.在master01上将证书复制到node节点</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /etc/kubernetes/
 
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> master2 master3 node1 node2 k8s-node03 k8s-node04 k8s-node05<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/pki<span class="token punctuation">;</span> <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig kube-proxy.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">scp</span> /etc/kubernetes/<span class="token variable">$FILE</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_8-2-kubelet配置"><a href="#_8-2-kubelet配置" class="header-anchor">#</a> 8.2.kubelet配置</h2> <h3 id="_8-2-1所有k8s节点创建相关目录"><a href="#_8-2-1所有k8s节点创建相关目录" class="header-anchor">#</a> 8.2.1所有k8s节点创建相关目录</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/

<span class="token comment"># 所有k8s节点配置kubelet service</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kubelet.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=containerd.service
Requires=containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet <span class="token entity" title="\\">\\</span>
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  <span class="token entity" title="\\">\\</span>
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig <span class="token entity" title="\\">\\</span>
    --config=/etc/kubernetes/kubelet-conf.yml <span class="token entity" title="\\">\\</span>
    --container-runtime=remote  <span class="token entity" title="\\">\\</span>
    --runtime-request-timeout=15m  <span class="token entity" title="\\">\\</span>
    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  <span class="token entity" title="\\">\\</span>
    --cgroup-driver=systemd <span class="token entity" title="\\">\\</span>
    --node-labels=node.kubernetes.io/node= <span class="token entity" title="\\">\\</span>
    --feature-gates=IPv6DualStack=true

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>注意若是CentOS7，将 <code>--node-labels=node.kubernetes.io/node=''</code> 替换为 <code>--node-labels=node.kubernetes.io/node=</code>
将 <code>''</code> 删除</p> <h3 id="_8-2-2所有k8s节点创建kubelet的配置文件"><a href="#_8-2-2所有k8s节点创建kubelet的配置文件" class="header-anchor">#</a> 8.2.2所有k8s节点创建kubelet的配置文件</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/kubernetes/kubelet-conf.yml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: true
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerLogMaxFiles: 5
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: true
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: true
enableDebuggingHandlers: true
enforceNodeAllocatable:
- pods
eventBurst: 10
eventRecordQPS: 5
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: true
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 20s
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m0s
iptablesDropBit: 15
iptablesMasqueradeBit: 14
kubeAPIBurst: 10
kubeAPIQPS: 5
makeIPTablesUtilChains: true
maxOpenFiles: 1000000
maxPods: 110
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
registryBurst: 10
registryPullQPS: 5
resolvConf: /etc/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 2m0s
serializeImagePulls: true
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><h3 id="_8-2-3启动kubelet"><a href="#_8-2-3启动kubelet" class="header-anchor">#</a> 8.2.3启动kubelet</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl restart kubelet
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_8-2-4查看集群"><a href="#_8-2-4查看集群" class="header-anchor">#</a> 8.2.4查看集群</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get node</span>
NAME           STATUS     ROLES    AGE   VERSION
master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   18s   v1.24.2
master2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   16s   v1.24.2
master3   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   16s   v1.24.2
node1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   14s   v1.24.2
node2     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   14s   v1.24.2
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment">#</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="_8-3-kube-proxy配置"><a href="#_8-3-kube-proxy配置" class="header-anchor">#</a> 8.3.kube-proxy配置</h2> <h3 id="_8-3-1将kubeconfig发送至其他节点"><a href="#_8-3-1将kubeconfig发送至其他节点" class="header-anchor">#</a> 8.3.1将kubeconfig发送至其他节点</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> master2 master3<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">scp</span> /etc/kubernetes/kube-proxy.kubeconfig <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">done</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> node1 node2 k8s-node03 k8s-node04 k8s-node05<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">scp</span> /etc/kubernetes/kube-proxy.kubeconfig <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig<span class="token punctuation">;</span>  <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_8-3-2所有k8s节点添加kube-proxy的service文件"><a href="#_8-3-2所有k8s节点添加kube-proxy的service文件" class="header-anchor">#</a> 8.3.2所有k8s节点添加kube-proxy的service文件</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span>  /usr/lib/systemd/system/kube-proxy.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-proxy <span class="token entity" title="\\">\\</span>
  --config=/etc/kubernetes/kube-proxy.yaml <span class="token entity" title="\\">\\</span>
  --v=2

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_8-3-3所有k8s节点添加kube-proxy的配置"><a href="#_8-3-3所有k8s节点添加kube-proxy的配置" class="header-anchor">#</a> 8.3.3所有k8s节点添加kube-proxy的配置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/kubernetes/kube-proxy.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
clientConnection:
  acceptContentTypes: &quot;&quot;
  burst: 10
  contentType: application/vnd.kubernetes.protobuf
  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
  qps: 5
clusterCIDR: 172.16.0.0/12,fc00::/48 
configSyncPeriod: 15m0s
conntrack:
  max: null
  maxPerCore: 32768
  min: 131072
  tcpCloseWaitTimeout: 1h0m0s
  tcpEstablishedTimeout: 24h0m0s
enableProfiling: false
healthzBindAddress: 0.0.0.0:10256
hostnameOverride: &quot;&quot;
iptables:
  masqueradeAll: false
  masqueradeBit: 14
  minSyncPeriod: 0s
  syncPeriod: 30s
ipvs:
  masqueradeAll: true
  minSyncPeriod: 5s
  scheduler: &quot;rr&quot;
  syncPeriod: 30s
kind: KubeProxyConfiguration
metricsBindAddress: 127.0.0.1:10249
mode: &quot;ipvs&quot;
nodePortAddresses: null
oomScoreAdj: -999
portRange: &quot;&quot;
udpIdleTimeout: 250ms

EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="_8-3-4启动kube-proxy"><a href="#_8-3-4启动kube-proxy" class="header-anchor">#</a> 8.3.4启动kube-proxy</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code> systemctl daemon-reload
 systemctl restart kube-proxy
 systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h1 id="_9-安装calico"><a href="#_9-安装calico" class="header-anchor">#</a> 9.安装Calico</h1> <h2 id="_9-1以下步骤只在master01操作"><a href="#_9-1以下步骤只在master01操作" class="header-anchor">#</a> 9.1以下步骤只在master01操作</h2> <h3 id="_9-1-1更改calico网段"><a href="#_9-1-1更改calico网段" class="header-anchor">#</a> 9.1.1更改calico网段</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># vim calico.yaml</span>
- name: CALICO_IPV4POOL_CIDR
      value: <span class="token string">&quot;172.16.0.0/12&quot;</span>
<span class="token comment"># kubectl apply -f calico.yaml</span>





<span class="token function">vim</span> calico-ipv6.yaml
<span class="token comment"># calico-config ConfigMap处</span>
    <span class="token string">&quot;ipam&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;calico-ipam&quot;</span>,
        <span class="token string">&quot;assign_ipv4&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,
        <span class="token string">&quot;assign_ipv6&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>
    <span class="token punctuation">}</span>,
    - name: IP
      value: <span class="token string">&quot;autodetect&quot;</span>

    - name: IP6
      value: <span class="token string">&quot;autodetect&quot;</span>

    - name: CALICO_IPV4POOL_CIDR
      value: <span class="token string">&quot;172.16.0.0/12&quot;</span>

    - name: CALICO_IPV6POOL_CIDR
      value: <span class="token string">&quot;fc00::/48&quot;</span>

    - name: FELIX_IPV6SUPPORT
      value: <span class="token string">&quot;true&quot;</span>


kubectl apply <span class="token parameter variable">-f</span> calico-ipv6.yaml 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="_9-1-2查看容器状态"><a href="#_9-1-2查看容器状态" class="header-anchor">#</a> 9.1.2查看容器状态</h3> <p>起不来检查libseccomp
<strong>libseccomp版本需要2.4以上</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get pod -A</span>
NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE
kube-system   calico-kube-controllers-56cdb7c587-bq6rn   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   calico-node-2vt27                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   calico-node-7bg82                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   calico-node-gg9tv                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   calico-node-lkdhr                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   calico-node-msl6j                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   calico-node-qqrx9                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   calico-node-tgzxk                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   calico-node-z59jx                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   calico-typha-6775694657-xzmcs              <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h1 id="_10-安装coredns"><a href="#_10-安装coredns" class="header-anchor">#</a> 10.安装CoreDNS</h1> <h2 id="_10-1以下步骤只在master01操作"><a href="#_10-1以下步骤只在master01操作" class="header-anchor">#</a> 10.1以下步骤只在master01操作</h2> <h3 id="_10-1-1修改文件"><a href="#_10-1-1修改文件" class="header-anchor">#</a> 10.1.1修改文件</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> coredns/
<span class="token function">cat</span> coredns.yaml <span class="token operator">|</span> <span class="token function">grep</span> clusterIP:
  clusterIP: <span class="token number">10.96</span>.0.10 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_10-1-2安装"><a href="#_10-1-2安装" class="header-anchor">#</a> 10.1.2安装</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl  create <span class="token parameter variable">-f</span> coredns.yaml 
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h1 id="_11-安装metrics-server"><a href="#_11-安装metrics-server" class="header-anchor">#</a> 11.安装Metrics Server</h1> <h2 id="_11-1以下步骤只在master01操作"><a href="#_11-1以下步骤只在master01操作" class="header-anchor">#</a> 11.1以下步骤只在master01操作</h2> <h3 id="_11-1-1安装metrics-server"><a href="#_11-1-1安装metrics-server" class="header-anchor">#</a> 11.1.1安装Metrics-server</h3> <p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 安装metrics server</span>
<span class="token builtin class-name">cd</span> metrics-server/

kubectl  apply <span class="token parameter variable">-f</span> metrics-server.yaml 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_11-1-2稍等片刻查看状态"><a href="#_11-1-2稍等片刻查看状态" class="header-anchor">#</a> 11.1.2稍等片刻查看状态</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl  <span class="token function">top</span> <span class="token function">node</span>
NAME           CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%   
master1   154m         <span class="token number">1</span>%     1715Mi          <span class="token number">21</span>%       
master2   151m         <span class="token number">1</span>%     1274Mi          <span class="token number">16</span>%       
master3   523m         <span class="token number">6</span>%     1345Mi          <span class="token number">17</span>%       
node1     84m          <span class="token number">1</span>%     671Mi           <span class="token number">8</span>%        
node2     73m          <span class="token number">0</span>%     727Mi           <span class="token number">9</span>%        
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h1 id="_12-集群验证"><a href="#_12-集群验证" class="header-anchor">#</a> 12.集群验证</h1> <h2 id="_12-1部署pod资源"><a href="#_12-1部署pod资源" class="header-anchor">#</a> 12.1部署pod资源</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>cat<span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -</span>
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
  - name: busybox
    image: busybox:1.28
    command:
      - sleep
      - &quot;3600&quot;
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
EOF</span>



<span class="token comment"># 查看</span>

kubectl  get pod
NAME      READY   STATUS    RESTARTS   AGE
busybox   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="_12-2用pod解析默认命名空间中的kubernetes"><a href="#_12-2用pod解析默认命名空间中的kubernetes" class="header-anchor">#</a> 12.2用pod解析默认命名空间中的kubernetes</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   17h


kubectl <span class="token builtin class-name">exec</span>  busybox <span class="token parameter variable">-n</span> default -- <span class="token function">nslookup</span> kubernetes
3Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.1 kubernetes.default.svc.cluster.local
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_12-3测试跨命名空间是否可以解析"><a href="#_12-3测试跨命名空间是否可以解析" class="header-anchor">#</a> 12.3测试跨命名空间是否可以解析</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">exec</span>  busybox <span class="token parameter variable">-n</span> default -- <span class="token function">nslookup</span> kube-dns.kube-system
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kube-dns.kube-system
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_12-4每个节点都必须要能访问kubernetes的kubernetes-svc-443和kube-dns的service-53"><a href="#_12-4每个节点都必须要能访问kubernetes的kubernetes-svc-443和kube-dns的service-53" class="header-anchor">#</a> 12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>telnet <span class="token number">10.96</span>.0.1 <span class="token number">443</span>
Trying <span class="token number">10.96</span>.0.1<span class="token punctuation">..</span>.
Connected to <span class="token number">10.96</span>.0.1.
Escape character is <span class="token string">'^]'</span><span class="token builtin class-name">.</span>

 telnet <span class="token number">10.96</span>.0.10 <span class="token number">53</span>
Trying <span class="token number">10.96</span>.0.10<span class="token punctuation">..</span>.
Connected to <span class="token number">10.96</span>.0.10.
Escape character is <span class="token string">'^]'</span><span class="token builtin class-name">.</span>

<span class="token function">curl</span> <span class="token number">10.96</span>.0.10:53
curl: <span class="token punctuation">(</span><span class="token number">52</span><span class="token punctuation">)</span> Empty reply from server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_12-5pod和pod之前要能通"><a href="#_12-5pod和pod之前要能通" class="header-anchor">#</a> 12.5Pod和Pod之前要能通</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl get po <span class="token parameter variable">-owide</span>
NAME      READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES
busybox   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17m   <span class="token number">172.27</span>.14.193   node2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

 kubectl get po <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-owide</span>
NAME                                       READY   STATUS    RESTARTS      AGE   IP               NODE           NOMINATED NODE   READINESS GATES
calico-kube-controllers-5dffd5886b-4blh6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             77m   <span class="token number">172.25</span>.244.193   master1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-fvbdq                          <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>75m ago<span class="token punctuation">)</span>   77m   <span class="token number">192.168</span>.200.101     master1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-g8nqd                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             77m   <span class="token number">192.168</span>.200.104     node1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-mdps8                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             77m   <span class="token number">192.168</span>.200.105     node2     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-nf4nt                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             77m   <span class="token number">192.168</span>.200.103     master3   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-sq2ml                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             77m   <span class="token number">192.168</span>.200.102     master2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-typha-8445487f56-mg6p8              <span class="token number">1</span>/1     Running   <span class="token number">0</span>             77m   <span class="token number">192.168</span>.200.105     node2     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-typha-8445487f56-pxbpj              <span class="token number">1</span>/1     Running   <span class="token number">0</span>             77m   <span class="token number">192.168</span>.200.101     master1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-typha-8445487f56-tnssl              <span class="token number">1</span>/1     Running   <span class="token number">0</span>             77m   <span class="token number">192.168</span>.200.104     node1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
coredns-5db5696c7-67h79                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>             63m   <span class="token number">172.25</span>.92.65     master2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
metrics-server-6bf7dcd649-5fhrw            <span class="token number">1</span>/1     Running   <span class="token number">0</span>             61m   <span class="token number">172.18</span>.195.1     master3   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

<span class="token comment"># 进入busybox ping其他节点上的pod</span>

kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-ti</span> busybox -- <span class="token function">sh</span>
/ <span class="token comment"># ping 192.168.200.104</span>
PING <span class="token number">192.168</span>.200.104 <span class="token punctuation">(</span><span class="token number">192.168</span>.200.104<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.200.104: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.358</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.200.104: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.668</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.200.104: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.637</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.200.104: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.624</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.200.104: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.907</span> ms

<span class="token comment"># 可以连通证明这个pod是可以跨命名空间和跨主机通信的</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="_12-6创建三个副本-可以看到3个副本分布在不同的节点上-用完可以删了"><a href="#_12-6创建三个副本-可以看到3个副本分布在不同的节点上-用完可以删了" class="header-anchor">#</a> 12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> deployments.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80

EOF</span>


kubectl  apply <span class="token parameter variable">-f</span> deployments.yaml 
deployment.apps/nginx-deployment created

kubectl  get pod 
NAME                               READY   STATUS    RESTARTS   AGE
busybox                            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m25s
nginx-deployment-9456bbbf9-4bmvk   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s
nginx-deployment-9456bbbf9-9rcdk   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s
nginx-deployment-9456bbbf9-dqv8s   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s

<span class="token comment"># 删除nginx</span>

<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f deployments.yaml </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h1 id="_13-安装dashboard"><a href="#_13-安装dashboard" class="header-anchor">#</a> 13.安装dashboard</h1> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> https://raw.githubusercontent.com/cby-chen/Kubernetes/main/yaml/dashboard.yaml
<span class="token function">wget</span> https://raw.githubusercontent.com/cby-chen/Kubernetes/main/yaml/dashboard-user.yaml

kubectl  apply <span class="token parameter variable">-f</span> dashboard.yaml
kubectl  apply <span class="token parameter variable">-f</span> dashboard-user.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_13-1更改dashboard的svc为nodeport-如果已是请忽略"><a href="#_13-1更改dashboard的svc为nodeport-如果已是请忽略" class="header-anchor">#</a> 13.1更改dashboard的svc为NodePort，如果已是请忽略</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl edit svc kubernetes-dashboard <span class="token parameter variable">-n</span> kubernetes-dashboard
  type: NodePort
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_13-2查看端口号"><a href="#_13-2查看端口号" class="header-anchor">#</a> 13.2查看端口号</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl get svc kubernetes-dashboard <span class="token parameter variable">-n</span> kubernetes-dashboard
NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
kubernetes-dashboard   NodePort   <span class="token number">10.108</span>.120.110   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>:30034/TCP   34s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_13-3创建token"><a href="#_13-3创建token" class="header-anchor">#</a> 13.3创建token</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token parameter variable">-n</span> kubernetes-dashboard create token admin-user
eyJhbGciOiJSUzI1NiIsImtpZCI6Inlkd0RKV2lQeUpvNmRxb2hENDlRM3llWU55T2I4dC0wVW5KOU5PZGRSdWsifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjU1NzA2MTQwLCJpYXQiOjE2NTU3MDI1NDAsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiZGVhYjdiY2MtNDczZS00N2E0LThlYTUtZmE4Yjc2NGY2NGJjIn19LCJuYmYiOjE2NTU3MDI1NDAsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.YzVrnSq3IuWn3qqY_td7SPqHisT40Gk1neMx7Ok9PsTxd6RASWxv9Y_1-T4wpE3ljaCiXxMBETzvYDgf-y9FOxm6drkQWWLk9UUuvOdjexxkdTXztB5X_0BiUGcMlvD3CA0qFbnzcg1cLpokypkuOnlSB8GBTleNyhQvHQnoXU3fSUCNRR_zHu2bRNgJZwABPMdj2D42EQndD56ZDP4g4IK8iMVJbaM-6DdNjdpfQx2358n8syPDjznu_1W1fUvwxY3eoEyeuIEjDbEeYEwh5uW2k4NOjW8m54W2YgmipDuqpvIB_-cnAo_KzF2q1Qb4WpIAItGkkpgwQFMFagKRTg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_13-3登录dashboard"><a href="#_13-3登录dashboard" class="header-anchor">#</a> 13.3登录dashboard</h2> <p>https://192.168.200.101:30034/</p> <h1 id="_14-ingress安装"><a href="#_14-ingress安装" class="header-anchor">#</a> 14.ingress安装</h1> <h2 id="_14-1执行部署"><a href="#_14-1执行部署" class="header-anchor">#</a> 14.1执行部署</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> ingress/

kubectl  apply <span class="token parameter variable">-f</span> deploy.yaml 

kubectl  apply <span class="token parameter variable">-f</span> backend.yaml 

<span class="token comment"># 等创建完成后在执行：</span>
kubectl  apply <span class="token parameter variable">-f</span> ingress-demo-app.yaml 

kubectl  get ingress
NAME               CLASS   HOSTS                            ADDRESS     PORTS   AGE
ingress-host-bar   nginx   hello.chenby.cn,demo.chenby.cn   <span class="token number">192.168</span>.200.102   <span class="token number">80</span>      7s

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="_14-2过滤查看ingress端口"><a href="#_14-2过滤查看ingress端口" class="header-anchor">#</a> 14.2过滤查看ingress端口</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hello ~/yaml<span class="token punctuation">]</span><span class="token comment"># kubectl  get svc -A | grep ingress</span>
ingress-nginx          ingress-nginx-controller             NodePort    <span class="token number">10.104</span>.231.36    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:32636/TCP,443:30579/TCP   104s
ingress-nginx          ingress-nginx-controller-admission   ClusterIP   <span class="token number">10.101</span>.85.88     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP                      105s
<span class="token punctuation">[</span>root@hello ~/yaml<span class="token punctuation">]</span><span class="token comment">#</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h1 id="_15-ipv6测试"><a href="#_15-ipv6测试" class="header-anchor">#</a> 15.IPv6测试</h1> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#部署应用</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># vim cby.yaml </span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># cat cby.yaml </span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chenby
spec:
  replicas: <span class="token number">3</span>
  selector:
    matchLabels:
      app: chenby
  template:
    metadata:
      labels:
        app: chenby
    spec:
      containers:
      - name: chenby
        image: nginx
        resources:
          limits:
            memory: <span class="token string">&quot;128Mi&quot;</span>
            cpu: <span class="token string">&quot;500m&quot;</span>
        ports:
        - containerPort: <span class="token number">80</span>

---
apiVersion: v1
kind: Service
metadata:
  name: chenby
spec:
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
  - IPv6
  - IPv4
  type: NodePort
  selector:
    app: chenby
  ports:
  - port: <span class="token number">80</span>
    targetPort: <span class="token number">80</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  apply -f cby.yaml</span>

<span class="token comment">#查看端口</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get svc</span>
NAME           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
chenby         NodePort    fd00::a29c       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:30779/TCP   5s
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token comment">#使用内网访问</span>
<span class="token punctuation">[</span>root@localhost yaml<span class="token punctuation">]</span><span class="token comment"># curl -I http://[fd00::a29c]</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.21.6
Date: Thu, 05 May <span class="token number">2022</span> <span class="token number">10</span>:20:35 GMT
Content-Type: text/html
Content-Length: <span class="token number">615</span>
Last-Modified: Tue, <span class="token number">25</span> Jan <span class="token number">2022</span> <span class="token number">15</span>:03:52 GMT
Connection: keep-alive
ETag: <span class="token string">&quot;61f01158-267&quot;</span>
Accept-Ranges: bytes

<span class="token punctuation">[</span>root@localhost yaml<span class="token punctuation">]</span><span class="token comment"># curl -I http://192.168.200.101:30779</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.21.6
Date: Thu, 05 May <span class="token number">2022</span> <span class="token number">10</span>:20:59 GMT
Content-Type: text/html
Content-Length: <span class="token number">615</span>
Last-Modified: Tue, <span class="token number">25</span> Jan <span class="token number">2022</span> <span class="token number">15</span>:03:52 GMT
Connection: keep-alive
ETag: <span class="token string">&quot;61f01158-267&quot;</span>
Accept-Ranges: bytes

<span class="token punctuation">[</span>root@localhost yaml<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token comment">#使用公网访问</span>

<span class="token punctuation">[</span>root@localhost yaml<span class="token punctuation">]</span><span class="token comment"># curl -I http://[2408:8207:78cc:5cc1:181c::10]:30779</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.21.6
Date: Thu, 05 May <span class="token number">2022</span> <span class="token number">10</span>:20:54 GMT
Content-Type: text/html
Content-Length: <span class="token number">615</span>
Last-Modified: Tue, <span class="token number">25</span> Jan <span class="token number">2022</span> <span class="token number">15</span>:03:52 GMT
Connection: keep-alive
ETag: <span class="token string">&quot;61f01158-267&quot;</span>
Accept-Ranges: bytes


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h1 id="_16-安装命令行自动补全功能"><a href="#_16-安装命令行自动补全功能" class="header-anchor">#</a> 16.安装命令行自动补全功能</h1> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> bash-completion <span class="token parameter variable">-y</span>
<span class="token builtin class-name">source</span> /usr/share/bash-completion/bash_completion
<span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">bash</span><span class="token punctuation">)</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;source &lt;(kubectl completion bash)&quot;</span> <span class="token operator">&gt;&gt;</span> ~/.bashrc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/zhangst94/zhangst94.github.io/edit/main/docs/01.运维/25.K8S/01.K8S安装篇/02.二进制安装Kubernetesv1.24.2IPv4、IPv6双栈.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/06/30, 22:48:29</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/4c4cd9/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Kubeadm高可用安装K8s集群1.24</div></a> <a href="/pages/87eacd/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">k8s证书有效期说明</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/4c4cd9/" class="prev">Kubeadm高可用安装K8s集群1.24</a></span> <span class="next"><a href="/pages/87eacd/">k8s证书有效期说明</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/5aff14/"><div>
            提问的智慧
            <!----></div></a> <span class="date">07-01</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/cc33f8/"><div>
            混沌工程
            <!----></div></a> <span class="date">07-01</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/b606dc/"><div>
            Docker In Docker
            <!----></div></a> <span class="date">07-01</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:12345@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/zhangst94" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2023
    <span>zhang | <a href="https://github.com/zhangst94/zhangst94.github.io/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.29507997.js" defer></script><script src="/assets/js/2.e4478836.js" defer></script><script src="/assets/js/49.86a92706.js" defer></script>
  </body>
</html>
