<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>K8S资源调度-StatefulSet | 运维技术笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/imgs/favicon.ico">
    <meta name="description" content="运维技术博客，积跬步以至千里，致敬每个爱学习的你">
    <meta name="keywords" content="个人技术博客,技术文档">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.44f28885.css" as="style"><link rel="preload" href="/assets/js/app.ff83aef7.js" as="script"><link rel="preload" href="/assets/js/2.e4478836.js" as="script"><link rel="preload" href="/assets/js/54.ca8519bb.js" as="script"><link rel="prefetch" href="/assets/js/10.52ab9d51.js"><link rel="prefetch" href="/assets/js/100.1857e137.js"><link rel="prefetch" href="/assets/js/101.1890600f.js"><link rel="prefetch" href="/assets/js/102.7012b4bb.js"><link rel="prefetch" href="/assets/js/103.a6b991c7.js"><link rel="prefetch" href="/assets/js/104.b9257dce.js"><link rel="prefetch" href="/assets/js/105.c3c52012.js"><link rel="prefetch" href="/assets/js/106.64058061.js"><link rel="prefetch" href="/assets/js/107.a37b1271.js"><link rel="prefetch" href="/assets/js/108.f3f2644b.js"><link rel="prefetch" href="/assets/js/109.45b0c459.js"><link rel="prefetch" href="/assets/js/11.348e09eb.js"><link rel="prefetch" href="/assets/js/110.52696f9e.js"><link rel="prefetch" href="/assets/js/111.5ec60f39.js"><link rel="prefetch" href="/assets/js/112.ec5fe640.js"><link rel="prefetch" href="/assets/js/113.084ab123.js"><link rel="prefetch" href="/assets/js/114.71eb8e47.js"><link rel="prefetch" href="/assets/js/115.32ffa2a4.js"><link rel="prefetch" href="/assets/js/116.1343b6cd.js"><link rel="prefetch" href="/assets/js/117.df0dcc03.js"><link rel="prefetch" href="/assets/js/118.de32b468.js"><link rel="prefetch" href="/assets/js/119.5e05a713.js"><link rel="prefetch" href="/assets/js/12.56ffb67a.js"><link rel="prefetch" href="/assets/js/120.90a4f281.js"><link rel="prefetch" href="/assets/js/121.b08c2f89.js"><link rel="prefetch" href="/assets/js/122.bebac8d5.js"><link rel="prefetch" href="/assets/js/123.70b2c752.js"><link rel="prefetch" href="/assets/js/124.ee663653.js"><link rel="prefetch" href="/assets/js/125.e16a9c74.js"><link rel="prefetch" href="/assets/js/126.777ed4a5.js"><link rel="prefetch" href="/assets/js/127.74e49495.js"><link rel="prefetch" href="/assets/js/128.623f6baf.js"><link rel="prefetch" href="/assets/js/129.afebfc59.js"><link rel="prefetch" href="/assets/js/13.08862d3f.js"><link rel="prefetch" href="/assets/js/130.a25d8347.js"><link rel="prefetch" href="/assets/js/131.15123040.js"><link rel="prefetch" href="/assets/js/132.228e6d11.js"><link rel="prefetch" href="/assets/js/133.55f18c73.js"><link rel="prefetch" href="/assets/js/134.1b48e840.js"><link rel="prefetch" href="/assets/js/135.9589d4eb.js"><link rel="prefetch" href="/assets/js/136.907aba41.js"><link rel="prefetch" href="/assets/js/137.7d3af1e6.js"><link rel="prefetch" href="/assets/js/138.e4e6009e.js"><link rel="prefetch" href="/assets/js/139.dfc3843f.js"><link rel="prefetch" href="/assets/js/14.52044c25.js"><link rel="prefetch" href="/assets/js/140.69c755af.js"><link rel="prefetch" href="/assets/js/141.d2d2f667.js"><link rel="prefetch" href="/assets/js/142.d2210074.js"><link rel="prefetch" href="/assets/js/143.5437963a.js"><link rel="prefetch" href="/assets/js/144.bc84e8f1.js"><link rel="prefetch" href="/assets/js/145.de58c85d.js"><link rel="prefetch" href="/assets/js/146.ec056ea7.js"><link rel="prefetch" href="/assets/js/147.21763bff.js"><link rel="prefetch" href="/assets/js/148.f106f8c4.js"><link rel="prefetch" href="/assets/js/15.ee7579c0.js"><link rel="prefetch" href="/assets/js/16.25869602.js"><link rel="prefetch" href="/assets/js/17.ac02c623.js"><link rel="prefetch" href="/assets/js/18.0cbba945.js"><link rel="prefetch" href="/assets/js/19.b3d532d8.js"><link rel="prefetch" href="/assets/js/20.02e842be.js"><link rel="prefetch" href="/assets/js/21.4e328e04.js"><link rel="prefetch" href="/assets/js/22.75d65205.js"><link rel="prefetch" href="/assets/js/23.7ad78c67.js"><link rel="prefetch" href="/assets/js/24.29059acc.js"><link rel="prefetch" href="/assets/js/25.9294d9f4.js"><link rel="prefetch" href="/assets/js/26.a5381927.js"><link rel="prefetch" href="/assets/js/27.30ff5d31.js"><link rel="prefetch" href="/assets/js/28.807737f2.js"><link rel="prefetch" href="/assets/js/29.f94bede1.js"><link rel="prefetch" href="/assets/js/3.602cbeca.js"><link rel="prefetch" href="/assets/js/30.cb467d3c.js"><link rel="prefetch" href="/assets/js/31.71830403.js"><link rel="prefetch" href="/assets/js/32.f441febc.js"><link rel="prefetch" href="/assets/js/33.6936c023.js"><link rel="prefetch" href="/assets/js/34.aa1da875.js"><link rel="prefetch" href="/assets/js/35.260c84c1.js"><link rel="prefetch" href="/assets/js/36.00aa73bf.js"><link rel="prefetch" href="/assets/js/37.981f7479.js"><link rel="prefetch" href="/assets/js/38.03635608.js"><link rel="prefetch" href="/assets/js/39.f0b194af.js"><link rel="prefetch" href="/assets/js/4.94dce7a4.js"><link rel="prefetch" href="/assets/js/40.2c37633e.js"><link rel="prefetch" href="/assets/js/41.8359d41f.js"><link rel="prefetch" href="/assets/js/42.824fd1a7.js"><link rel="prefetch" href="/assets/js/43.c7dbc936.js"><link rel="prefetch" href="/assets/js/44.d4d3017a.js"><link rel="prefetch" href="/assets/js/45.3d6f1906.js"><link rel="prefetch" href="/assets/js/46.f04b397d.js"><link rel="prefetch" href="/assets/js/47.29b4bd1e.js"><link rel="prefetch" href="/assets/js/48.c41e811d.js"><link rel="prefetch" href="/assets/js/49.86a92706.js"><link rel="prefetch" href="/assets/js/5.20b1f052.js"><link rel="prefetch" href="/assets/js/50.8f4d5d52.js"><link rel="prefetch" href="/assets/js/51.ae98a632.js"><link rel="prefetch" href="/assets/js/52.eef6f2a5.js"><link rel="prefetch" href="/assets/js/53.288a2c34.js"><link rel="prefetch" href="/assets/js/55.c68c02af.js"><link rel="prefetch" href="/assets/js/56.764027ee.js"><link rel="prefetch" href="/assets/js/57.e66955e3.js"><link rel="prefetch" href="/assets/js/58.65d82ca7.js"><link rel="prefetch" href="/assets/js/59.8c7d8021.js"><link rel="prefetch" href="/assets/js/6.117df427.js"><link rel="prefetch" href="/assets/js/60.a7717958.js"><link rel="prefetch" href="/assets/js/61.f2234096.js"><link rel="prefetch" href="/assets/js/62.0975d1f9.js"><link rel="prefetch" href="/assets/js/63.6b4a98a2.js"><link rel="prefetch" href="/assets/js/64.87f76657.js"><link rel="prefetch" href="/assets/js/65.1a214a9d.js"><link rel="prefetch" href="/assets/js/66.17496a38.js"><link rel="prefetch" href="/assets/js/67.7010581e.js"><link rel="prefetch" href="/assets/js/68.2a82295a.js"><link rel="prefetch" href="/assets/js/69.fa5521f2.js"><link rel="prefetch" href="/assets/js/7.734b9314.js"><link rel="prefetch" href="/assets/js/70.b98a93ee.js"><link rel="prefetch" href="/assets/js/71.b86293e6.js"><link rel="prefetch" href="/assets/js/72.af5b5715.js"><link rel="prefetch" href="/assets/js/73.6cca4579.js"><link rel="prefetch" href="/assets/js/74.cc567bc3.js"><link rel="prefetch" href="/assets/js/75.6f849f86.js"><link rel="prefetch" href="/assets/js/76.163b3ebb.js"><link rel="prefetch" href="/assets/js/77.1707618a.js"><link rel="prefetch" href="/assets/js/78.4dd46cb2.js"><link rel="prefetch" href="/assets/js/79.afaf1984.js"><link rel="prefetch" href="/assets/js/8.bbb15a0b.js"><link rel="prefetch" href="/assets/js/80.83c95867.js"><link rel="prefetch" href="/assets/js/81.8d050311.js"><link rel="prefetch" href="/assets/js/82.b49696a4.js"><link rel="prefetch" href="/assets/js/83.1658ba7c.js"><link rel="prefetch" href="/assets/js/84.4d61c624.js"><link rel="prefetch" href="/assets/js/85.c0639c78.js"><link rel="prefetch" href="/assets/js/86.061e2dd4.js"><link rel="prefetch" href="/assets/js/87.2ead0414.js"><link rel="prefetch" href="/assets/js/88.d4c09c55.js"><link rel="prefetch" href="/assets/js/89.24585fec.js"><link rel="prefetch" href="/assets/js/9.76379761.js"><link rel="prefetch" href="/assets/js/90.97829613.js"><link rel="prefetch" href="/assets/js/91.95cbbfb2.js"><link rel="prefetch" href="/assets/js/92.a26ed5cd.js"><link rel="prefetch" href="/assets/js/93.f7e9ec93.js"><link rel="prefetch" href="/assets/js/94.a5e34e19.js"><link rel="prefetch" href="/assets/js/95.4eedbabc.js"><link rel="prefetch" href="/assets/js/96.baaeea76.js"><link rel="prefetch" href="/assets/js/97.afa3b440.js"><link rel="prefetch" href="/assets/js/98.9022c603.js"><link rel="prefetch" href="/assets/js/99.b145e5c5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.44f28885.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/imgs/logo.png" alt="运维技术笔记" class="logo"> <span class="site-name can-hide">运维技术笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/yunwei/" class="nav-link">运维</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/book/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/more/" class="nav-link">更多</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/zhangst94/zhangst94.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/imgs/t.jpg"> <div class="blogger-info"><h3>Zhang</h3> <span>运维小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/yunwei/" class="nav-link">运维</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/book/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/more/" class="nav-link">更多</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/zhangst94/zhangst94.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tomcat</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker-compose</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Containerd</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dragonfly</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>K8S</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S安装篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>K8S基础篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/afe0a1/" class="sidebar-link">K8S基础概念</a></li><li><a href="/pages/f9f6c2/" class="sidebar-link">K8S资源调度-RC&amp;RS</a></li><li><a href="/pages/4b4543/" class="sidebar-link">K8S资源调度-Deployment</a></li><li><a href="/pages/4c9852/" aria-current="page" class="active sidebar-link">K8S资源调度-StatefulSet</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/4c9852/#statefulset的基本概念" class="sidebar-link">StatefulSet的基本概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4c9852/#statefulset注意事项" class="sidebar-link">StatefulSet注意事项</a></li><li class="sidebar-sub-header level3"><a href="/pages/4c9852/#为什么要用headless-service-statefulset部署有状态应用" class="sidebar-link">为什么要用headless service+statefulSet部署有状态应用?</a></li><li class="sidebar-sub-header level4"><a href="/pages/4c9852/#headless-services介绍" class="sidebar-link">Headless Services介绍</a></li><li class="sidebar-sub-header level4"><a href="/pages/4c9852/#_1、headless-service和普通service的区别" class="sidebar-link">1、headless Service和普通Service的区别</a></li><li class="sidebar-sub-header level4"><a href="/pages/4c9852/#_2、statefulset和deployment控制器的区别" class="sidebar-link">2、statefulSet和Deployment控制器的区别</a></li><li class="sidebar-sub-header level4"><a href="/pages/4c9852/#_3、普通service解析service的dns结果" class="sidebar-link">3、普通Service解析service的DNS结果</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4c9852/#定义一个-statefulset-资源文件" class="sidebar-link">定义一个 StatefulSet 资源文件</a></li><li class="sidebar-sub-header level2"><a href="/pages/4c9852/#扩容缩容" class="sidebar-link">扩容缩容</a></li><li class="sidebar-sub-header level2"><a href="/pages/4c9852/#statefulset更新策略" class="sidebar-link">StatefulSet更新策略</a></li><li class="sidebar-sub-header level2"><a href="/pages/4c9852/#statefulset灰度发布" class="sidebar-link">StatefulSet灰度发布</a></li><li class="sidebar-sub-header level2"><a href="/pages/4c9852/#statefulset级联删除和非级联删除" class="sidebar-link">StatefulSet级联删除和非级联删除</a></li></ul></li><li><a href="/pages/dc38eb/" class="sidebar-link">K8S资源调度-DaemonSet</a></li><li><a href="/pages/5f2ba1/" class="sidebar-link">K8S资源调度-HPA</a></li><li><a href="/pages/fb354c/" class="sidebar-link">K8S-LabelSelector</a></li><li><a href="/pages/33c3be/" class="sidebar-link">K8S服务发布-Service</a></li><li><a href="/pages/7a7dec/" class="sidebar-link">K8S服务发布-Ingress</a></li><li><a href="/pages/bf977c/" class="sidebar-link">K8S配置管理-Configmap</a></li><li><a href="/pages/2e489a/" class="sidebar-link">K8S配置管理-Secret</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S进阶篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S高级篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S运维篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S拓展篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>实践记录</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MYSQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Oracle</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Jenkins</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ZooKeeper</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Kafka</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>mq</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nightingale</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Prometheus</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>VictoriaMetrics</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Zabbix</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OpenLDAP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>混沌工程</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/yunwei/#运维" data-v-06225672>运维</a></li><li data-v-06225672><a href="/yunwei/#K8S" data-v-06225672>K8S</a></li><li data-v-06225672><a href="/yunwei/#K8S基础篇" data-v-06225672>K8S基础篇</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/zhangst94" target="_blank" title="作者" class="beLink" data-v-06225672>zhang</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-06-02</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">K8S资源调度-StatefulSet<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="有状态应用管理-statefulset"><a href="#有状态应用管理-statefulset" class="header-anchor">#</a> 有状态应用管理 StatefulSet</h1> <p>StatefulSet(有状态集，缩写为sts）常用于部署有状态的且需要有序启动的应用程序，比如在进行SpringCloud项目容器化时，Eureka的部署是比较适合用StatefulSet部署方式的，可以给每个Eureka实例创建一个唯一且固定的标识符，并且每个Eureka实例无需配置多余的Service，其余Spring Boot应用可以直接通过Eureka的 Headless Service即可进行注册。</p> <p>Eureka 的 statefulset,的资源名称是eureka，eureka-0          eureka-1 eureka-2</p> <p>Service：headless service，没有ClusterIP     eureka-svc</p> <p>Eureka-0.eureka-svc.NAMESPACE_NAME         eureka-1.eureka-svc ...</p> <h2 id="statefulset的基本概念"><a href="#statefulset的基本概念" class="header-anchor">#</a> StatefulSet的基本概念</h2> <p>StatefulSet主要用于管理有状态应用程序的工作负载API对象。比如在生产环境中，可以部署ElasticSearch集群、MongoDB集群或者需要持久化的RabbitMQ集群、Redis集群、Kafka集群和ZooKeeper.集群等。</p> <p>和 Deployment类似，一个StatefulSet也同样管理着基于相同容器规范的Pod。不同的是，StatefulSet为每个Pod维护了一个粘性标识。这些Pod是根据相同的规范创建的，但是不可互换，每个 Pod 都有一个持久的标识符，在重新调度时也会保留，一般格式为StatefulSetName-Number。比如定义一个名字是Redis-Sentinel的 StatefulSet，指定创建三个Pod，那么创建出来的Pod 名字就为Redis-Sentinel-0、Redis-Sentinel-1、Redis-Sentinel-2。而StatefulSet创建的Pod一般使用Headless Service(无头服务〉进行通信，和普通的Service的区别在于Headless Service没有ClusterIP，它使用的是Endpoint 进行互相通信，Headless一般的格式为:</p> <p>statefulSetName-{0..N-1 } . serxicelName.namespace.svc.clustex.local。</p> <p>说明：</p> <p>serviceName为Headless Service的名字，创建StatefulSet时，必须指定Headless Service名称；</p> <p>0..N-1为Pod所在的序号，从0开始到N-1；</p> <p>statefulSetName为StatefulSet的名字；</p> <p>namespace为服务所在的命名空间；</p> <p>.cluster.local为Cluster Domain（集群域）</p> <p>假如公司某个项目需要在Kubernetes中部署一个主从模式的Redis，此时使用StatefulSet部署就极为合适，因为StatefulSet启动时，只有当前一个容器完全启动时，后一个容器才会被调度，并且每个容器的标识符是固定的，那么就可以通过标识符来断定当前Pod的角色</p> <p>比如用一个名为 redis-ms 的 StatefulSet 部署主从架构的 Redis，第一个容器启动时，它的标识符为 redis-ms-0，并且 Pod 内主机名也为 redis-ms-0，此时就可以根据主机名来判断，当主机名为 redis-ms-0 的容器作为 Redis 的主节点，其余从节点，那么 Slave 连接 Master 主机配置就可以使用不会更改的 Master 的 Headless Serivce，此时 Redis 从节点（Slave）配置文件如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>port <span class="token number">6379</span>
slaveof redis-ms-0.redis-ms.public-service.svc.cluster.local <span class="token number">6379</span>
tcp-backlog <span class="token number">511</span>
<span class="token function">timeout</span> <span class="token number">0</span>
tcp-keeplive <span class="token number">0</span>
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>其中 redis-ms-0.redis-ms.public-service.svc.cluster.local 是 Redis Master 的 Headless Service，在同一命名空间下只需要写 redis-ms-0.redis-ms 即可，后面的 public-service.svc.cluster.local 可以省略。</p> <h3 id="statefulset注意事项"><a href="#statefulset注意事项" class="header-anchor">#</a> StatefulSet注意事项</h3> <p>一般StatefulSet用于有以下一个或者多个需求的应用程序：</p> <ol><li><code>需要稳定的独一无二的网络标识符。</code></li> <li><code>需要持久化数据。</code></li> <li><code>需要有序的、优雅的部署和扩展。</code></li> <li><code>需要有序的自动滚动更新。</code></li></ol> <p>如果应用程序不需要任何稳定的标识符或者有序的部署、删除或者扩展，应该使用无状态的控制器部署应用程序，比如Deployment或者ReplicaSet。</p> <p>StatefulSet是Kubernetes 1.9版本之前的beta资源，在1.5版本之前的任何Kubernetes版本都没有。</p> <p>Pod所用的存储必须由PersistentVolume Provisioner（持久化卷配置器）根据请求配置StorageClass，或者由管理员预先配置，当然也可以不配置存储。</p> <p>为了确保数据安全，删除和缩放StatefulSet不会删除与StatefulSet关联的卷，可以手动选择性地删除PVC和PV）。</p> <p>StatefulSet目前使用Headless Service（无头服务）负责Pod的网络身份和通信，需要提前创建此服务。
删除一个StatefulSet时，不保证对Pod的终止，要在StatefulSet中实现Pod的有序和正常终止，可以在删除之前将StatefulSet的副本缩减为0</p> <h3 id="为什么要用headless-service-statefulset部署有状态应用"><a href="#为什么要用headless-service-statefulset部署有状态应用" class="header-anchor">#</a> 为什么要用headless service+statefulSet部署有状态应用?</h3> <h4 id="headless-services介绍"><a href="#headless-services介绍" class="header-anchor">#</a> Headless Services介绍</h4> <p>Headless Services是一种特殊的service，其spec:clusterIP表示为None，这样在实际运行时就不会被分配ClusterIP。也被称为无头服务。</p> <h4 id="_1、headless-service和普通service的区别"><a href="#_1、headless-service和普通service的区别" class="header-anchor">#</a> 1、headless Service和普通Service的区别</h4> <p>headless不分配clusterIP</p> <p>headless service可以通过解析service的DNS，返回所有Pod的地址和域名(statefulSet部署的Pod才有域名)</p> <p><strong>headless service会为关联的Pod分配一个域：
service-name.namespace-name.svc.cluster.local</strong></p> <p>普通的service，只能通过解析service的DNS返回service的ClusterIP</p> <h4 id="_2、statefulset和deployment控制器的区别"><a href="#_2、statefulset和deployment控制器的区别" class="header-anchor">#</a> 2、statefulSet和Deployment控制器的区别</h4> <p>statefulSet下的Pod有DNS地址,通过解析Pod的DNS可以返回Pod的IP</p> <p><strong>StatefulSet会为关联的Pod保持一个不变的Pod Name
statefulset中Pod的hostname格式为
statefulsetname-(pod序号)</strong></p> <p>而deployment下的Pod没有具体的域名，想访问Pod都是通过普通service来负载均衡到后端pod，无法指定访问具体哪个Pod</p> <h4 id="_3、普通service解析service的dns结果"><a href="#_3、普通service解析service的dns结果" class="header-anchor">#</a> 3、普通Service解析service的DNS结果</h4> <p>Service的ClusterIP工作原理：一个service可能对应一组endpoints(所有pod的地址+端口)，client访问ClusterIP，通过iptables或者ipvs转发到Real Server(Pod)。</p> <p><strong>StatefulSet+headless service会为关联的每个Pod都分配一个具体的域名：
Pod-Name.service-name.namespace-name.svc.cluster.local</strong></p> <h2 id="定义一个-statefulset-资源文件"><a href="#定义一个-statefulset-资源文件" class="header-anchor">#</a> 定义一个 StatefulSet 资源文件</h2> <p>定义一个简单的 StatefulSet 的示例如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> web
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> <span class="token string">&quot;nginx&quot;</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> web

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>其中：</p> <ul><li>kind：Service 定义了一个名字为 Nginx 的 Headless Service，创建的 Service格式为 nginx-0.nginx.default.svc.cluster.local，因为没有指定 Namespace （命名空间），所以默认部署在 default。</li> <li>kind：StatefulSet 定义了一个名字为 web 的StatefulSet，replicas 表示部署 Pod 的副本数，本实例为2。</li></ul> <p>在 StatefulSet 中必须设置 Pod 选择器（.spec.selector）用来匹配其标签（.spec.template.metadata.labels）。在1.8版本之前，如果未配置该字段（.spec.selector），将被设置为默认值。在1.8版本之后，如果为指定匹配Pod Selector，则会导致 StatefulSet 创建错误。</p> <p>当 StatefulSet 控制器创建 Pod 时，它会添加一个标签 statefulset.kubernetes.io/pod-name ， 该标签的值为 Pod的名称，用于匹配 Service。</p> <p>使用 <code>kubectl apply</code> 创建</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span> statefulset.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>1.28.4
      <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> sleep
        <span class="token punctuation">-</span> <span class="token string">&quot;3600&quot;</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token key atrule">limits</span><span class="token punctuation">:</span>
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;128Mi&quot;</span>
          <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;500m&quot;</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> busybox -- <span class="token function">sh</span>
/ <span class="token comment"># nslookup web-0.nginx</span>
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-0.nginx
Address <span class="token number">1</span>: <span class="token number">10.1</span>.0.198 web-0.nginx.default.svc.cluster.local
/ <span class="token comment"># nslookup web-1.nginx</span>
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-1.nginx
Address <span class="token number">1</span>: <span class="token number">10.1</span>.0.199 web-1.nginx.default.svc.cluster.local

$ kubectl get pods <span class="token parameter variable">-o</span> wide
NAME      READY   STATUS    RESTARTS   AGE     IP           NODE             NOMINATED NODE   READINESS GATES
busybox   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m52s   <span class="token number">10.1</span>.0.202   docker-desktop   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
web-0     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m     <span class="token number">10.1</span>.0.198   docker-desktop   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
web-1     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m     <span class="token number">10.1</span>.0.199   docker-desktop   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>nslookup 命令的输出结果中，我们可以看到，在访问 web-0.nginx 的时候，最后解析
到的，正是 web-0 这个 Pod 的 IP 地址；而当访问 web-1.nginx 的时候，解析到的则是
web-1 的 IP 地址。</p> <h2 id="扩容缩容"><a href="#扩容缩容" class="header-anchor">#</a> 扩容缩容</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ kubectl scale <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">3</span> sts web
statefulset.apps/web scaled
$ kubectl get pods
NAME      READY   STATUS    RESTARTS      AGE
web-0     <span class="token number">1</span>/1     Running   <span class="token number">0</span>             40m
web-1     <span class="token number">1</span>/1     Running   <span class="token number">0</span>             40m
web-2     <span class="token number">1</span>/1     Running   <span class="token number">0</span>             11m

$ kubectl scale <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">2</span> sts web
statefulset.apps/web scaled
$ kubectl get pods
NAME      READY   STATUS    RESTARTS      AGE
web-0     <span class="token number">1</span>/1     Running   <span class="token number">0</span>             41m
web-1     <span class="token number">1</span>/1     Running   <span class="token number">0</span>             41m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>StatefulSet副本启动顺序按照名称0，1，2，只有web-0完全启动之后才会启动web-1，web-1完全启动之后才会启动web-2</p> <p>删除的时候顺序与启动相反，从最后一个序号开始，2，1，0，如果web-2删除过程中，web-0挂掉了，那么web-1不会被删除，必须等待web-0启动状态变为ready之后，才会删除web-1</p> <p>StatefulSet滚动更新的时候会先删除旧的副本，再创建新的副本，如果只有一个副本的话，会导致业务不可用，所以要根据自己的实际情况选择使用StatefulSet或者Deployment，如果必须固定主机名或者pod名称，建议使用StatefulSet</p> <h2 id="statefulset更新策略"><a href="#statefulset更新策略" class="header-anchor">#</a> StatefulSet更新策略</h2> <p>更新策略：</p> <ul><li><strong>rollingUpdate</strong>: 当updateStrategy的值被设置为RollingUpdate时，StatefulSet  Controller会删除并创建StatefulSet相关的每个Pod对象，其处理顺序与StatefulSet终止Pod的顺序一致，即从序号最大的Pod开始重建，每次更新一个Pod。</li> <li><strong>onDelete</strong>：当updateStrategy的值被设置为OnDelete时，StatefulSet  Controller并不会自动更新StatefulSet中的Pod实例，而是需要用户手动删除这些Pod并触发StatefulSet  Controller创建新的Pod实例来弥补，因此这其实是一种手动升级模式。</li> <li><strong>Partitione</strong> :  updateStrategy也支持特殊的分区升级策略（Partitione），在这种模式下，用户指定一个序号，StatefulSet中序号大于等于此序号的Pod实例会全部被升级，小于此序号的Pod实例则保留旧版本不变，即使这些Pod被删除、重建，也仍然保持原来的旧版本。这种分区升级策略通常用于按计划分步骤的系统升级过程中。</li></ul> <h2 id="statefulset灰度发布"><a href="#statefulset灰度发布" class="header-anchor">#</a> StatefulSet灰度发布</h2> <p>修改配置</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit sts web</span>
<span class="token comment"># 修改以下内容</span>
updateStrategy:
type: RollingUpdate 
rollingUpdate:
partition: <span class="token number">2</span> <span class="token comment"># 小于2的不会被更新</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以使用这种机制实现灰度机制，先发布一两个实例，确认没有问题之后再发布所有实例，这就是stateful的分段更新，相当于灰度发布的机制，也可以使用其它的方式，比如服务网格，或者myservices</p> <h2 id="statefulset级联删除和非级联删除"><a href="#statefulset级联删除和非级联删除" class="header-anchor">#</a> StatefulSet级联删除和非级联删除</h2> <ul><li>级联删除：删除sts时同时删除Pod</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code> <span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete sts web</span>
 statefulset.apps <span class="token string">&quot;web&quot;</span> deleted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>非级联删除：删除sts时不删Pod</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete sts web --cascade=false</span>
warning: <span class="token parameter variable">--cascade</span><span class="token operator">=</span>false is deprecated <span class="token punctuation">(</span>boolean value<span class="token punctuation">)</span> and can be replaced with <span class="token parameter variable">--cascade</span><span class="token operator">=</span>orphan.
statefulset.apps <span class="token string">&quot;web&quot;</span> deleted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查看pod，可以看到pod依然存在，只是没有sts管理了，再次删除pod不会被重新创建</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/zhangst94/zhangst94.github.io/edit/main/docs/01.运维/25.K8S/02.K8S基础篇/04.K8S资源调度-StatefulSet.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/07/03, 13:23:27</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/4b4543/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">K8S资源调度-Deployment</div></a> <a href="/pages/dc38eb/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">K8S资源调度-DaemonSet</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/4b4543/" class="prev">K8S资源调度-Deployment</a></span> <span class="next"><a href="/pages/dc38eb/">K8S资源调度-DaemonSet</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/5aff14/"><div>
            提问的智慧
            <!----></div></a> <span class="date">07-01</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/cc33f8/"><div>
            混沌工程
            <!----></div></a> <span class="date">07-01</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/b606dc/"><div>
            Docker In Docker
            <!----></div></a> <span class="date">07-01</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:12345@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/zhangst94" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2023
    <span>zhang | <a href="https://github.com/zhangst94/zhangst94.github.io/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.ff83aef7.js" defer></script><script src="/assets/js/2.e4478836.js" defer></script><script src="/assets/js/54.ca8519bb.js" defer></script>
  </body>
</html>
