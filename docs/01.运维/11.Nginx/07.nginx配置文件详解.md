---
title: nginx配置文件详解
date: 2023-04-14 17:34:33
permalink: /pages/9ad084/
categories:
  - 运维
  - Linux
tags:
  - 
author: 
  name: zhang
  link: https://github.com/zhangst94
---
## Nginx

### 配置管理nginx.conf

```nginx
########### 每个指令必须有分号结束。#################
#user administrator administrators;  #配置用户或者组，默认为nobody nobody。
#worker_processes 2;  #允许生成的进程数，默认为1
#pid /nginx/pid/nginx.pid;   #指定nginx进程运行文件存放地址
error_log log/error.log debug;  #制定日志路径，级别。这个设置可以放入全局块，http块，server块，级别以此为：debug|info|notice|warn|error|crit|alert|emerg
events {
    accept_mutex on;   #设置网路连接序列化，防止惊群现象发生，默认为on
    multi_accept on;  #设置一个进程是否同时接受多个网络连接，默认为off
    #use epoll;      #事件驱动模型，select|poll|kqueue|epoll|resig|/dev/poll|eventport
    worker_connections  1024;    #最大连接数，默认为512
}
http {
    include       mime.types;   #文件扩展名与文件类型映射表
    default_type  application/octet-stream; #默认文件类型，默认为text/plain
    #access_log off; #取消服务日志    
    log_format myFormat '$remote_addr–$remote_user [$time_local] $request $status $body_bytes_sent $http_referer $http_user_agent $http_x_forwarded_for'; #自定义格式
    access_log log/access.log myFormat;  #combined为日志格式的默认值
    sendfile on;   #允许sendfile方式传输文件，默认为off，可以在http块，server块，location块。
    sendfile_max_chunk 100k;  #每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。
    keepalive_timeout 65;  #连接超时时间，默认为75s，可以在http，server，location块。

    upstream mysvr {   
      server 127.0.0.1:7878;
      server 192.168.10.121:3333 backup;  #热备
    }
    error_page 404 https://www.baidu.com; #错误页
    server {
        keepalive_requests 120; #单连接请求上限次数。
        listen       4545;   #监听端口
        server_name  127.0.0.1;   #监听地址       
        location  ~*^.+$ {       #请求的url过滤，正则匹配，~为区分大小写，~*为不区分大小写。
           #root path;  #根目录
           #index vv.txt;  #设置默认页
           proxy_pass  http://mysvr;  #请求转向mysvr 定义的服务器列表
           deny 127.0.0.1;  #拒绝的ip
           allow 172.18.5.54; #允许的ip           
        } 
    }
}
```



```nginx
# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes auto;		#允许生成的进程数，取决于CPU核数
error_log /var/log/nginx/error.log;		#错误日志
pid /run/nginx.pid;		 #主进程id，指定nginx进程运行文件存放地址

# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;		##worker进程处理的请求数
}
##服务器核心配置
http {
		##日志格式
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
		##访问日志
    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
	##会话保持时间
    keepalive_timeout   65;
    types_hash_max_size 4096;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;		#引入子配置文件

    server {
        listen       80;		##监听所有的ipv4的地址
        listen       [::]:80;	##监听所有的ipv6的地址
        server_name  _;
        root         /usr/share/nginx/html;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
    }

# Settings for a TLS enabled server.
#
#    server {
#        listen       443 ssl http2;
#        listen       [::]:443 ssl http2;
#        server_name  _;
#        root         /usr/share/nginx/html;
#
#        ssl_certificate "/etc/pki/nginx/server.crt";
#        ssl_certificate_key "/etc/pki/nginx/private/server.key";
#        ssl_session_cache shared:SSL:1m;
#        ssl_session_timeout  10m;
#        ssl_ciphers HIGH:!aNULL:!MD5;
#        ssl_prefer_server_ciphers on;
#
#        # Load configuration files for the default server block.
#        include /etc/nginx/default.d/*.conf;
#
#        error_page 404 /404.html;
#            location = /40x.html {
#        }
#
#        error_page 500 502 503 504 /50x.html;
#            location = /50x.html {
#        }
#    }

}
```

```nginx
server {
        listen       80;
        listen       [::]:80;
        server_name  _;
        root         /usr/share/nginx/html;	

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;
         location = /hello {
        	root         /usr/share/nginx/html;		##网站目录	目录/URL
    		index        index.html index.htm;		#默认首页	index.html
        }

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
```

### 自定义站点

1.获取信息

站点名称：mysite.com

端口：81

站点目录：/opt/mysite

2.创建站点 

```shell
[root@localhost ~]# mkdir -p /opt/mysite
[root@localhost ~]# cd /opt/mysite/
[root@localhost mysite]# ls
[root@localhost mysite]# echo mysite > index.com
[root@localhost mysite]# mkdir static
[root@localhost mysite]# echo static > static/index.com 
```

3.配置nginx服务

```nginx
server {
        listen       81;
        listen       [::]:80;
        server_name  mysite.com;
        root         /opt/mysite;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;
         location = /static {
        	root         /opt/mysite;		##网站目录	目录/URL
    		index        index.html index.htm;		#默认首页	index.html
        }

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
}
```

4.启动nginx

```shell
vim /etc/nginx/conf.d/mysite.conf
```

5.安全配置

安全组（开放端口）

```shell
systemctl stop firewalld	#关闭防火墙
```

6.配置域名

域名-->解析成IP

买一个域名：

本地hosts

win：C:\Windows\System32\drivers\etc\hosts

### nginx配置虚拟主机

- 基于IP虚拟主机
- 基于端口的虚拟主机
- 基于域名
- 基于访问路径配置

#### 基于IP配置虚拟主机

每台机器配置一个站点

#### 基于端口配置虚拟主机

- site1:/opt/site1
- site2:/opt/site2

```nginx
server {
        listen       82;
        listen       [::]:82;
        server_name  _;
        root         /opt/site1;
        index        index.html index.htm;
        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
}
```

```nginx
server {
        listen       83;
        listen       [::]:83;
        server_name  _;
        root         /opt/site2;
        index        index.html index.htm;
        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
}
```

#### 基于域名配置虚拟主机

- mysite1.com /opt mysite1
- mysite2.com /opt mysite2

```shell 
mkdir /opt/mysite1 /opt/mysite2

echo mysite1 >/opt/mysite1/index.html
echo mysite2 >/opt/mysite1/index.html
```

配置站点

```nginx
server {
        listen       85;
        listen       [::]:85;
        server_name  mysite1.com;
        root         /opt/mysite1;
        index        index.html index.htm;
        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
}
```

```nginx
server {
        listen       86;
        listen       [::]:86;
        server_name  mysite1.com;
        root         /opt/mysite2;
        index        index.html index.htm;
        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
}
```

基于访问路径配置虚拟主机

```nginx
server {
        listen       80;
        listen       [::]:80;
        server_name  _;
        root         /opt;
        index        index.html index.htm;
        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;
        location = /site1 {
        }        
        location = /site2 {
        }
        location = /site3 {
        }
        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
}
```

### nginx配置代理服务器

一台机器：运行一个代理站点和两个其他站点

创建数据

- proxysite1:/opt/proxy1
- proxysite2:/opt/proxy2

```shell
mkdir /opt/proxy1 /opt/proxy2
echo "my proxy site1" > /opt/proxy1/index.html
echo "my proxy site2" > /opt/proxy2/index.html
```

创建站点

proxy1

```nginx
server {
        listen       87;
        listen       [::]:87;
        server_name  _;
        root         /opt/proxy1;
        index        index.html index.htm;
        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
}
```

proxy2

```nginx
server {
        listen       88;
        listen       [::]:88;
        server_name  _;
        root         /opt/proxy2;
        index        index.html index.htm;
        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
}
```

proxy

```nginx
server {
    listen       89;
    location / {
        proxy_pass http://192.168.100.128:88/;
    }

    location ~ \.(gif|jpg|png)$ {
        root /data/images;
    }
}
```



[Module ngx_http_proxy_module](http://nginx.org/en/docs/http/ngx_http_proxy_module.html)

```nginx
proxy_pass		##设置代理服务器的协议和地址以及位置应映射到的可选 URI。作为协议，可以指定“ http”或“ https”。地址可以指定为域名或 IP 地址，以及可选的端口：
```

### 配置NGINX支持PHP网站解析

#### 静动分离

```nginx
server {
        listen       81;
        listen       [::]:80;
        server_name  mysite.com;
        root         /opt/mysite;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;
         location = /static {
        	root         /opt/mysite;		##网站目录	目录/URL
    		index        index.html index.htm;		#默认首页	index.html
        }
       location /.php$ {
        root   /opt/mysite;
        index  index.php;
        fastcgi_pass  localhost:9000;
        fastcgi_param SCRIPT_FILENAME /home/www/scripts/php$fastcgi_script_name;
        fastcgi_param QUERY_STRING $query_string;
        include fastcgi_params;
    }

}
```

准备php页面

```php
<?php
    phpinfo();
?>
```



### nginx配置负载均衡器

```nginx
http {
    upstream backend {
        server backend1.example.com;
        server backend2.example.com;
        server 192.0.0.1 backup;
    }
    
    server {
        location / {
            proxy_pass http://backend;
        }
    }
}
```

服务器权重

```nginx
upstream backend {
    server backend1.example.com weight=5;
    server backend2.example.com;
    server 192.0.0.1 backup;
}
#weight 参数server设置服务器的权重；默认是1
#在这个例子中，backend1.example.com有 weight 5；其他两台服务器有默认权重（1），但有 IP 地址的那台192.0.0.1被标记为backup服务器，除非其他两台服务器都不可用，否则不会接收请求。随着权重的这种配置，每的6请求，5发送到backend1.example.com和1对backend2.example.com。

### nginx隐藏版本号
将nginx.conf文件里面加上server_tokens off;
```


