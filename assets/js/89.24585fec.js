(window.webpackJsonp=window.webpackJsonp||[]).push([[89],{415:function(s,e,n){"use strict";n.r(e);var t=n(4),a=Object(t.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"coredns域名解析延迟"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#coredns域名解析延迟"}},[s._v("#")]),s._v(" Coredns域名解析延迟")]),s._v(" "),e("h2",{attrs:{id:"dns-5-秒延时"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#dns-5-秒延时"}},[s._v("#")]),s._v(" DNS 5 秒延时")]),s._v(" "),e("h2",{attrs:{id:"现象"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#现象"}},[s._v("#")]),s._v(" 现象")]),s._v(" "),e("p",[s._v("用户反馈从 pod 中访问服务时，总是有些请求的响应时延会达到5秒。正常的响应只需要毫秒级别的时延。")]),s._v(" "),e("h2",{attrs:{id:"抓包"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#抓包"}},[s._v("#")]),s._v(" 抓包")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://imroc.cc/kubernetes/trick/network/enter-netns-with-nsenter.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用 nsenter 进入 netns"),e("OutboundLink")],1),s._v("，然后使用节点上的 tcpdump 抓 pod 中的包，发现是有的 DNS 请求没有收到响应，超时 5 秒后，再次发送 DNS 请求才成功收到响应。")]),s._v(" "),e("li",[s._v("在 kube-dns pod 抓包，发现是有 DNS 请求没有到达 kube-dns pod，在中途被丢弃了。")])]),s._v(" "),e("p",[s._v("为什么是 5 秒？ "),e("code",[s._v("man resolv.conf")]),s._v(" 可以看到 glibc 的 resolver 的缺省超时时间是 5s:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("timeout:n\n       Sets the amount of time the resolver will wait for a response from a remote name server before retrying the query via a different name server.  Measured in seconds, the default is RES_TIMEOUT (currently  5,  see\n       <resolv.h>).  The value for this option is silently capped to 30.\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"丢包原因"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#丢包原因"}},[s._v("#")]),s._v(" 丢包原因")]),s._v(" "),e("p",[s._v("经过搜索发现这是一个普遍问题。")]),s._v(" "),e("p",[s._v("根本原因是内核 conntrack 模块的 bug，netfilter 做 NAT 时可能发生资源竞争导致部分报文丢弃。")]),s._v(" "),e("p",[s._v("Weave works的工程师 "),e("a",{attrs:{href:"https://imroc.cc/kubernetes/troubleshooting/cases/network/martynas@weave.works",target:"_blank",rel:"noopener noreferrer"}},[s._v("Martynas Pumputis"),e("OutboundLink")],1),s._v(" 对这个问题做了很详细的分析："),e("a",{attrs:{href:"https://www.weave.works/blog/racy-conntrack-and-dns-lookup-timeouts",target:"_blank",rel:"noopener noreferrer"}},[s._v("Racy conntrack and DNS lookup timeouts"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("相关结论：")]),s._v(" "),e("ul",[e("li",[s._v("只有多个线程或进程，并发从同一个 socket 发送相同五元组的 UDP 报文时，才有一定概率会发生")]),s._v(" "),e("li",[s._v('glibc, musl(alpine linux的libc库)都使用 "parallel query", 就是并发发出多个查询请求，因此很容易碰到这样的冲突，造成查询请求被丢弃')]),s._v(" "),e("li",[s._v("由于 ipvs 也使用了 conntrack, 使用 kube-proxy 的 ipvs 模式，并不能避免这个问题")])]),s._v(" "),e("h2",{attrs:{id:"问题的根本解决"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题的根本解决"}},[s._v("#")]),s._v(" 问题的根本解决")]),s._v(" "),e("p",[s._v("Martynas 向内核提交了两个 patch 来 fix 这个问题，不过他说如果集群中有多个DNS server的情况下，问题并没有完全解决。")]),s._v(" "),e("p",[s._v("其中一个 patch 已经在 2018-7-18 被合并到 linux 内核主线中: "),e("a",{attrs:{href:"https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ed07d9a021df6da53456663a76999189badc432a",target:"_blank",rel:"noopener noreferrer"}},[s._v("netfilter: nf_conntrack: resolve clash for matching conntracks"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("目前只有4.19.rc 版本包含这个patch。")]),s._v(" "),e("h2",{attrs:{id:"规避办法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#规避办法"}},[s._v("#")]),s._v(" 规避办法")]),s._v(" "),e("h3",{attrs:{id:"规避方案一-使用tcp发送dns请求"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#规避方案一-使用tcp发送dns请求"}},[s._v("#")]),s._v(" 规避方案一：使用TCP发送DNS请求")]),s._v(" "),e("p",[s._v("由于TCP没有这个问题，有人提出可以在容器的resolv.conf中增加"),e("code",[s._v("options use-vc")]),s._v(", 强制glibc使用TCP协议发送DNS query。下面是这个man resolv.conf中关于这个选项的说明：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("use-vc (since glibc 2.14)\n                     Sets RES_USEVC in _res.options.  This option forces the\n                     use of TCP for DNS resolutions.\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v('笔者使用镜像"busybox:1.29.3-glibc" (libc 2.24) 做了试验，并没有见到这样的效果，容器仍然是通过UDP发送DNS请求。')]),s._v(" "),e("h3",{attrs:{id:"规避方案二-避免相同五元组dns请求的并发"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#规避方案二-避免相同五元组dns请求的并发"}},[s._v("#")]),s._v(" 规避方案二：避免相同五元组DNS请求的并发")]),s._v(" "),e("p",[s._v("resolv.conf还有另外两个相关的参数：")]),s._v(" "),e("ul",[e("li",[s._v("single-request-reopen (since glibc 2.9)")]),s._v(" "),e("li",[s._v("single-request (since glibc 2.10)")])]),s._v(" "),e("p",[s._v("man resolv.conf中解释如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("single-request-reopen (since glibc 2.9)\n                     Sets RES_SNGLKUPREOP in _res.options.  The resolver\n                     uses the same socket for the A and AAAA requests.  Some\n                     hardware mistakenly sends back only one reply.  When\n                     that happens the client system will sit and wait for\n                     the second reply.  Turning this option on changes this\n                     behavior so that if two requests from the same port are\n                     not handled correctly it will close the socket and open\n                     a new one before sending the second request.\n\nsingle-request (since glibc 2.10)\n                     Sets RES_SNGLKUP in _res.options.  By default, glibc\n                     performs IPv4 and IPv6 lookups in parallel since\n                     version 2.9.  Some appliance DNS servers cannot handle\n                     these queries properly and make the requests time out.\n                     This option disables the behavior and makes glibc\n                     perform the IPv6 and IPv4 requests sequentially (at the\n                     cost of some slowdown of the resolving process).\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[s._v("用自己的话解释下：")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("single-request-reopen")]),s._v(": 发送 A 类型请求和 AAAA 类型请求使用不同的源端口，这样两个请求在 conntrack 表中不占用同一个表项，从而避免冲突")]),s._v(" "),e("li",[e("code",[s._v("single-request")]),s._v(": 避免并发，改为串行发送 A 类型和 AAAA 类型请求，没有了并发，从而也避免了冲突")])]),s._v(" "),e("p",[s._v("要给容器的 "),e("code",[s._v("resolv.conf")]),s._v(" 加上 options 参数，有几个办法：")]),s._v(" "),e("ol",[e("li",[s._v('在容器的 "ENTRYPOINT" 或者 "CMD" 脚本中，执行 /bin/echo \'options single-request-reopen\' >> /etc/resolv.conf**')]),s._v(" "),e("li",[s._v("在 pod 的 postStart hook 中:")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("        lifecycle:\n          postStart:\n            exec:\n              command:\n              - /bin/sh\n              - -c \n              - \"/bin/echo 'options single-request-reopen' >> /etc/resolv.conf\"\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("ol",[e("li",[s._v("使用 template.spec.dnsConfig (k8s v1.9 及以上才支持):")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("  template:\n    spec:\n      dnsConfig:\n        options:\n          - name: single-request-reopen\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ol",[e("li",[s._v("使用 ConfigMap 覆盖 pod 里面的 /etc/resolv.conf:")])]),s._v(" "),e("p",[s._v("configmap:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("apiVersion: v1\ndata:\n  resolv.conf: |\n    nameserver 1.2.3.4\n    search default.svc.cluster.local svc.cluster.local cluster.local ec2.internal\n    options ndots:5 single-request-reopen timeout:1\nkind: ConfigMap\nmetadata:\n  name: resolvconf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("pod spec:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("        volumeMounts:\n        - name: resolv-conf\n          mountPath: /etc/resolv.conf\n          subPath: resolv.conf\n...\n\n      volumes:\n      - name: resolv-conf\n        configMap:\n          name: resolvconf\n          items:\n          - key: resolv.conf\n            path: resolv.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("ol",[e("li",[s._v("使用 MutatingAdmissionWebhook")])]),s._v(" "),e("p",[e("a",{attrs:{href:"https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook-beta-in-1-9",target:"_blank",rel:"noopener noreferrer"}},[s._v("MutatingAdmissionWebhook"),e("OutboundLink")],1),s._v(" 是 1.9 引入的 Controller，用于对一个指定的 Resource 的操作之前，对这个 resource 进行变更。 istio  的自动 sidecar注入就是用这个功能来实现的。 我们也可以通过  MutatingAdmissionWebhook，来自动给所有POD，注入以上3)或者4)所需要的相关内容。")]),s._v(" "),e("p",[s._v("以上方法中， 1 和 2 都需要修改镜像， 3 和 4 则只需要修改 pod 的 spec， 能适用于所有镜像。不过还是有不方便的地方：")]),s._v(" "),e("ul",[e("li",[s._v("每个工作负载的yaml都要做修改，比较麻烦")]),s._v(" "),e("li",[s._v("对于通过helm创建的工作负载，需要修改helm charts")])]),s._v(" "),e("p",[s._v("方法5)对集群使用者最省事，照常提交工作负载即可。不过初期需要一定的开发工作量。")]),s._v(" "),e("h3",{attrs:{id:"最佳实践-使用-localdns"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#最佳实践-使用-localdns"}},[s._v("#")]),s._v(" 最佳实践：使用 LocalDNS")]),s._v(" "),e("p",[s._v("容器的DNS请求都发往本地的DNS缓存服务 (dnsmasq, nscd 等)，不需要走DNAT，也不会发生conntrack冲突。另外还有个好处，就是避免DNS服务成为性能瓶颈。")]),s._v(" "),e("p",[s._v("使用 LocalDNS 缓存有两种方式：")]),s._v(" "),e("ul",[e("li",[s._v("每个容器自带一个DNS缓存服务")]),s._v(" "),e("li",[s._v("每个节点运行一个DNS缓存服务，所有容器都把本节点的DNS缓存作为自己的 nameserver")])]),s._v(" "),e("p",[s._v("从资源效率的角度来考虑的话，推荐后一种方式。官方也意识到了这个问题比较常见，给出了 coredns 以 cache 模式作为 daemonset 部署的解决方案: https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/")]),s._v(" "),e("h3",{attrs:{id:"实施办法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实施办法"}},[s._v("#")]),s._v(" 实施办法")]),s._v(" "),e("p",[s._v("条条大路通罗马，不管怎么做，最终到达上面描述的效果即可。")]),s._v(" "),e("p",[s._v("POD中要访问节点上的DNS缓存服务，可以使用节点的IP。 如果节点上的容器都连在一个虚拟bridge上， 也可以使用这个bridge的三层接口的IP(在TKE中，这个三层接口叫cbr0)。 要确保DNS缓存服务监听这个地址。")]),s._v(" "),e("p",[s._v("如何把 POD 的 /etc/resolv.conf 中的 nameserver 设置为节点IP呢？")]),s._v(" "),e("p",[s._v('一个办法，是设置 POD.spec.dnsPolicy 为 "Default"， 意思是POD里面的 /etc/resolv.conf，  使用节点上的文件。缺省使用节点上的 /etc/resolv.conf  (如果kubelet通过参数--resolv-conf指定了其他文件，则使用--resolv-conf所指定的文件)。')]),s._v(" "),e("p",[s._v('另一个办法，是给每个节点的kubelet指定不同的--cluster-dns参数，设置为节点的IP，POD.spec.dnsPolicy仍然使用缺省值"ClusterFirst"。 kops项目甚至有个issue在讨论如何在部署集群时设置好--cluster-dns指向节点IP: https://github.com/kubernetes/kops/issues/5584')]),s._v(" "),e("p",[s._v("参考：https://imroc.cc/kubernetes/troubleshooting/cases/network/dns-lookup-5s-delay.html")])])}),[],!1,null,null,null);e.default=a.exports}}]);